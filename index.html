<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>The805Lab - Simulateur Budget</title>

<!-- Plotly pour les distributions -->
<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>

<style>
  :root{
    --bg:#0a1022; --panel:#0f1a33; --panel2:#0b1530; --ring:#21315a;
    --text:#e8f0ff; --muted:#a7b5cf;
    --ok:#16a34a; --bad:#ef4444;
    --expBg:#0e254f; --revBg:#0b1f45;
    --chip:#0c1636; --brand:#2563eb;
    --you:#38bdf8; --ref:#eab308; --axis:#94a3b8;
    --good:#16a34a; --bad2:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;touch-action:pan-y}
  .wrap{max-width:980px;margin:0 auto;padding:16px}

  /* Top header with logo pinned right even on mobile */
  .topHeader{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:nowrap}
  .titleCol{min-width:0;flex:1 1 auto}
  h1{margin:0;font-size:1.22rem;line-height:1.25}
  .subtitle{color:var(--muted);font-size:.92rem;margin-top:4px;margin-bottom:10px}

  .brandBadge805{flex:0 0 auto;display:flex;align-items:center;justify-content:center}
  .brandBadge805 svg{display:block;width:44px;height:44px}
  @media (max-width:380px){ .brandBadge805 svg{width:36px;height:36px} }

  .bar{height:10px;background:#1a2746;border-radius:999px;overflow:hidden;margin:8px 0 14px}
  .bar>span{display:block;height:100%;background:linear-gradient(90deg,#dc2626,#eab308,#16a34a);width:0%}

  .card{background:var(--panel);border:1px solid var(--ring);border-radius:14px;padding:14px;margin:12px 0}
  .section{border-radius:16px;border:1px solid var(--ring);margin:14px 0;overscroll-behavior:contain;overflow:visible}
  .section.exp{background:var(--expBg)} .section.rev{background:var(--revBg)}
  .head{padding:12px 14px;background:rgba(255,255,255,.05);display:flex;gap:12px;align-items:center;font-weight:700;flex-wrap:wrap}
  .badge{padding:2px 8px;border-radius:999px;border:1px solid var(--ring);background:#0b152f;color:#dce7ff;font-size:.8rem}
  .row{padding:12px 14px;border-top:1px dashed #274067}
  .label{font-weight:700}
  .hint{color:var(--muted);font-size:.9rem;margin-top:2px}
  .detailInfo{color:#97a8c9;font-size:.86rem;margin-top:4px}
  .baseInfo{color:#cbd5e1;font-size:.86rem;margin-top:2px}

  .sliderWrap{display:grid;grid-template-columns:48px 1fr 48px;gap:8px;align-items:center;margin-top:8px}
  .nudge{width:48px;height:48px;border-radius:12px;border:1px solid var(--ring);background:#0b1633;color:#cfe1ff;cursor:pointer;font-weight:700;font-size:1rem;touch-action:manipulation}
  .nudge:active{transform:scale(.98)}
  .nudge[disabled]{opacity:.4;cursor:not-allowed}
  input[type=range]{width:100%;margin:8px 0;height:36px;touch-action:pan-y}
  input[type=range]::-webkit-slider-runnable-track{height:10px;background:#2a3c69;border-radius:999px}
  input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;margin-top:-7px;width:28px;height:28px;border-radius:50%;background:var(--brand);border:2px solid #a5b4fc}
  input[type=range]::-moz-range-track{height:10px;background:#2a3c69;border-radius:999px}
  input[type=range]::-moz-range-thumb{width:28px;height:28px;border:none;border-radius:50%;background:var(--brand)}
  input[type=range][disabled]{opacity:.6}

  .valLine{display:flex;justify-content:space-between;gap:8px;margin-top:6px;align-items:center}
  .delta{font-variant-numeric:tabular-nums}
  .delta.gain{color:var(--ok)} .delta.loss{color:var(--bad)}

  /* HUD flottant */
  .floatBubble{
    position:fixed; right:14px; bottom:14px; z-index:50;background:#0b172f;border:1px solid var(--ring);
    border-radius:12px; padding:10px 12px;box-shadow:0 6px 24px rgba(0,0,0,.35); font-size:.95rem;
    border-left:6px solid var(--bad);
  }
  .floatBubble.ok{ border-left-color: var(--ok); }
  .floatBubble strong{color:#fff}

  .btn{display:inline-flex;gap:.6rem;align-items:center;background:var(--brand);color:#fff;border:0;border-radius:12px;padding:14px 16px;cursor:pointer;font-weight:700;font-size:1.02rem}
  .btn:disabled{background:#334155;color:#94a3b8;cursor:not-allowed}
  .btn.wide{width:100%} @media (min-width:760px){.btn.wide{width:auto;padding:12px 18px}}

  .results{display:none}
  .legend{color:var(--muted);font-size:.9rem;margin:6px 0 8px}

  /* Grille des violons */
  .violinsGrid{display:grid;grid-template-columns:1fr;gap:12px}
  @media (min-width:760px){.violinsGrid{grid-template-columns:1fr 1fr}}

  .footer{color:var(--muted);font-size:.85rem;margin-top:16px;position:relative;padding-bottom:12px}
  .toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:#0b172f;border:1px solid var(--ring);color:#e6f0ff;border-radius:10px;padding:10px 12px;box-shadow:0 6px 20px rgba(0,0,0,.35);z-index:60;display:none}

  /* Synth√®se (barres centr√©es sur 0) */
  .synCard{background:#0b1935;border:1px solid #1e2d55;border-radius:14px;padding:14px}
  .synHeader{display:flex;justify-content:space-between;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
  .synBadge{border:1px solid #274067;border-radius:999px;padding:2px 8px;color:#d9e3ff;background:#0c1a3a;font-size:.8rem}
  .synH{margin:0 0 4px;font-size:1.05rem}
  .sumLine{font-size:1rem;margin:2px 0 8px}

  .listWrap{display:grid;grid-template-columns:1fr;gap:10px}
  @media (min-width:760px){.listWrap{grid-template-columns:1fr 1fr}}
  .listBox{border:1px dashed #2a3c64;border-radius:12px;padding:10px}
  .listTitle{font-weight:700;margin-bottom:6px}
  .zeroLine{position:relative;height:2px;background:rgba(148,163,184,.5);margin:8px 0}

  /* Mini-bar per item */
  .item{display:grid;grid-template-columns:1fr auto;gap:8px;margin:8px 0}
  .itemLabel{color:#dbe7ff}
  .itemVal{font-variant-numeric:tabular-nums}
  .barLine{position:relative;height:14px;border:1px solid #233047;border-radius:999px;background:#0b1633;overflow:hidden}
  .barSeg{position:absolute;top:0;height:100%}
  .barZero{position:absolute;top:0;bottom:0;width:2px;background:rgba(255,255,255,.55);opacity:.6}
  .segGood{background:rgba(22,163,74,.9)}
  .segBad{background:rgba(239,68,68,.9)}
  .seeMore{display:none}

  /* Gel apr√®s validation (s√©curit√©) */
  body[data-frozen="1"] input[type=range],
  body[data-frozen="1"] .nudge{pointer-events:none}
</style>
</head>
<body>

<div class="wrap" aria-live="polite">
  <div class="topHeader">
    <div class="titleCol">
      <h1>√Ä vous de trouver <strong>40 Md‚Ç¨</strong> pour le budget 2026 de la France</h1>
      <div class="subtitle">R√©f√©rence : <em>base 2024</em></div>
    </div>
    <!-- Logo The805Lab (inline SVG rond + mot-symbole sur 3 lignes) -->
    <div class="brandBadge805" aria-label="The805Lab" title="The805Lab">
      <svg viewBox="0 0 64 64" role="img" aria-label="The805Lab">
        <defs>
          <linearGradient id="gradBR" x1="0" x2="1" y1="0" y2="1">
            <stop offset="0" stop-color="#2563eb"/>
            <stop offset="1" stop-color="#ef4444"/>
          </linearGradient>
        </defs>
        <circle cx="32" cy="32" r="30" fill="url(#gradBR)" opacity="0.9" stroke="#21315a" stroke-width="2"/>
        <g font-family="Inter,system-ui,Segoe UI,Roboto,Arial" fill="#e8f0ff" font-weight="800">
          <text x="32" y="24" text-anchor="middle" font-size="10">The</text>
          <text x="32" y="36" text-anchor="middle" font-size="12">805</text>
          <text x="32" y="48" text-anchor="middle" font-size="10">Lab</text>
        </g>
      </svg>
    </div>
  </div>

  <!-- Intro p√©dagogique -->
  <div class="card" style="background:#0b1935;border-color:#1e2d55;">
    <div class="subtitle" style="color:#d9e3ff">
      <strong>Pourquoi cet exercice ?</strong><br/>
      Le d√©ficit public correspond √† la diff√©rence entre toutes les d√©penses de l‚Äô√âtat et des administrations publiques et leurs recettes sur une ann√©e. En 2024, la France d√©pense encore davantage qu‚Äôelle ne re√ßoit : la dette augmente. L‚Äôobjectif europ√©en est de revenir vers 3 % du PIB de d√©ficit.<br/>
      Ici, vous testez des arbitrages pour trouver entre <strong>40 et 45 Md‚Ç¨</strong> ‚Äì ordre de grandeur discut√© politiquement en ce moment ‚Äì en jouant sur des postes de d√©penses et de recettes, afin de visualiser les impacts et vous comparez aux autres Fran√ßais.
    </div>
    <div class="hint" style="margin-top:8px;color:#a7b5cf">
      <strong>Nota bene.</strong> Exercice volontairement <em>simplifi√©</em> : on ajuste des pourcentages sur de grandes cat√©gories de d√©penses et de recettes. Cela ne correspond pas directement √† des mesures d√©taill√©es, mais permet de se faire un avis sur les efforts √† r√©partir.
    </div>
  </div>

  <div class="bar" aria-hidden="true"><span id="bar"></span></div>

  <!-- D√©penses -->
  <div class="section exp" aria-label="R√©glages des d√©penses">
    <div class="head">D√©penses <span class="badge">curseurs ‚àí15 % √† +15 %</span></div>
    <div id="expContainer"></div>
  </div>

  <!-- Recettes -->
  <div class="section rev" aria-label="R√©glages des recettes">
    <div class="head">Recettes <span class="badge">curseurs ‚àí15 % √† +15 %</span></div>
    <div id="revContainer"></div>
  </div>

  <!-- Actions -->
  <div class="card">
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <button id="validateBtn" class="btn wide" disabled aria-disabled="true">Valider mon budget</button>
      <button id="editBtn" class="btn" style="display:none;background:#334155">Modifier mon sc√©nario</button>
      <button id="shareBtn" class="btn" style="display:none;background:#0b1736;border:1px solid #2b3d6d">Partager</button>
    </div>
    <div class="hint" id="validateHint" style="margin-top:6px;">Le bouton s‚Äôactive quand l‚Äô√©conomie est entre 40 000 et 45 000 M‚Ç¨.</div>
  </div>

  <!-- Synth√®se de mes r√©sultats -->
  <div id="summary" class="card results" aria-label="Synth√®se de mes r√©sultats">
    <div class="synHeader">
      <h2 class="synH">Synth√®se de mes r√©sultats</h2>
      <span class="synBadge" id="targetBadge">Hors cible</span>
    </div>
    <div class="sumLine" id="sumHeadline">‚Äî</div>

    <div class="legend" style="margin-top:4px">Barres par poste : <strong>vert</strong> = r√©duit le d√©ficit, <strong>rouge</strong> = l‚Äôaugmente.</div>

    <div class="listWrap">
      <!-- D√©penses -->
      <div class="listBox">
        <div class="listTitle" id="listTitleExp">D√©penses ‚Äî variations par poste</div>
        <div id="sumExpList"></div>
      </div>
      <!-- Recettes -->
      <div class="listBox">
        <div class="listTitle" id="listTitleRev">Recettes ‚Äî variations par poste</div>
        <div id="sumRevList"></div>
      </div>
    </div>
  </div>

  <!-- Comparaison normalis√©e -->
  <div id="results" class="card results">
    <h2 style="margin:0 0 10px;font-size:1.06rem">Mes r√©sultats compar√©s aux autres r√©pondants</h2>
    <div class="hint" id="ansCountLine" style="margin:-2px 0 8px;color:#cbd5e1"></div>

    <!-- Barres centr√©es sur 0 : Vous vs M√©diane (totaux) -->
    <div class="synCard">
      <div class="hint" id="barExpTitle" style="margin-bottom:6px"><strong>Variation totale des d√©penses (M‚Ç¨)</strong></div>
      <div class="barLine" style="margin-bottom:6px">
        <div class="barSeg" id="barExpZero" style="left:50%;width:2px;background:rgba(148,163,184,.6)"></div>
        <div class="barSeg" id="barExpRef" style="left:50%;width:3px;background:var(--ref)"></div>
        <div class="barSeg" id="barExpYou" style="left:50%;width:3px;background:var(--you)"></div>
      </div>
    </div>

    <div class="synCard" style="margin-top:10px">
      <div class="hint" id="barRevTitle" style="margin-bottom:6px"><strong>Variation totale des recettes (M‚Ç¨)</strong></div>
      <div class="barLine" style="margin-bottom:6px">
        <div class="barSeg" id="barRevZero" style="left:50%;width:2px;background:rgba(148,163,184,.6)"></div>
        <div class="barSeg" id="barRevRef" style="left:50%;width:3px;background:var(--ref)"></div>
        <div class="barSeg" id="barRevYou" style="left:50%;width:3px;background:var(--you)"></div>
      </div>
    </div>

    <div class="legend" id="normNote" style="margin-top:10px">
      Chaque graphique montre la distribution des r√©ponses (variation en M‚Ç¨ vs 2024).
    </div>

    <!-- Violons -->
    <div class="section exp" style="margin-top:10px">
      <div class="head">D√©penses ‚Äî variation (M‚Ç¨)</div>
      <div id="violins-expenses" class="violinsGrid"></div>
    </div>
    <div class="section rev" style="margin-top:10px">
      <div class="head">Recettes ‚Äî variation (M‚Ç¨)</div>
      <div id="violins-revenues" class="violinsGrid"></div>
    </div>
  </div>

  <div class="footer">
    Sources : Insee (APU), Minist√®re de l‚Äô√âconomie, Commission europ√©enne. Chiffres 2024 arrondis. Certains postes sont difficiles √† ajuster √† court terme (ex. int√©r√™ts de la dette).
  </div>
</div>

<!-- Bulle flottante -->
<div id="hud" class="floatBubble" aria-live="polite">
  <div>√âconomie : <strong id="hudSaving">0 M‚Ç¨</strong></div>
  <div style="color:var(--muted)">√âcart : <strong id="hudGap">‚â•40 000 M‚Ç¨</strong></div>
</div>

<div id="toast" class="toast" role="status"></div>

<script>
/* --------- CONFIG ---------- */
const ENDPOINT_URL = "https://script.google.com/macros/s/AKfycbxHnolZm-C31zBPKrg7sWLNLGD9PELL5en5OBDjGuDjPvgZydE_cY_WoNv7Q_-ms8Ur/exec"; // <= mets ici l'URL /exec du d√©ploiement en cours
const SHARE_URL = window.location.origin + window.location.pathname; // ou colle l‚ÄôURL publique si besoin

const CFG = {
  target:{min:40000, max:45000},
  expenses: [
    {k:"prot_soc",label:"Protection sociale",base:701400,locked:false,info:"Retraites, assurance ch√¥mage, minima sociaux, prestations familiales, aides handicap."},
    {k:"sante",label:"Sant√©",base:250500,locked:false,info:"H√¥pitaux, soins de ville, m√©dicaments, pr√©vention, sant√© publique."},
    {k:"education",label:"√âducation",base:167000,locked:false,info:"√âcoles, coll√®ges, lyc√©es, universit√©s, vie √©tudiante, orientation."},
    {k:"serv_gen",label:"Services publics g√©n√©raux (hors int√©r√™ts de la dette)",base:120000,locked:false,info:"√âtat, administrations centrales, coordination, fonctions transverses, R&D publique g√©n√©rale."},
    {k:"interets_dette",label:"Charges d‚Äôint√©r√™ts de la dette (non modifiable)",base:58700,locked:true,info:"Service de la dette de l‚Äô√âtat (verrouill√© √† court terme)."},
    {k:"aff_econ",label:"Affaires √©conomiques",base:167000,locked:false,info:"Transports, agriculture, √©nergie, industrie, emploi, soutien √† l‚Äôinvestissement."},
    {k:"defense",label:"D√©fense",base:75200,locked:false,info:"Renseignement, forces, √©quipements, dissuasion, OPEX, maintien en condition."},
    {k:"ordre_secu",label:"Ordre & s√©curit√© publics",base:50100,locked:false,info:"Police, gendarmerie, justice p√©nale, administration p√©nitentiaire, s√©curit√© civile."},
    {k:"logement",label:"Logement & √©quipements collectifs",base:30100,locked:false,info:"Aides au logement, urbanisme, infrastructures locales."},
    {k:"environnement",label:"Protection de l‚Äôenvironnement",base:30100,locked:false,info:"D√©chets, eau, air, biodiversit√©, climat."},
    {k:"culture",label:"Culture, loisirs et cultes",base:20000,locked:false,info:"Culture, sport, patrimoine, biblioth√®ques, cultes."},
  ],
  revenues: [
    {k:"imp_prod",label:"Imp√¥ts sur la production et importations",base:570000,info:"TVA et taxes sur la consommation, accises, droits de douane."},
    {k:"cotis",label:"Cotisations sociales",base:480000,info:"Cotisations employeurs/salari√©s (retraites, sant√©, ch√¥mage)."},
    {k:"ir",label:"Imp√¥t sur le revenu (IRPP)",base:120000,info:"Pr√©l√®vement √† la source et acomptes des m√©nages."},
    {k:"is",label:"Imp√¥t sur les soci√©t√©s",base:80000,info:"Imp√¥t sur les b√©n√©fices des entreprises."},
    {k:"autres_rec",label:"Autres recettes",base:252000,info:"Dividendes et revenus patrimoniaux publics, amendes, redevances, loyers/cessions, divers."},
  ],
  range:{min:-15,max:15}
};

/* --------- STATE ---------- */
const state = {
  expPct: CFG.expenses.map(()=>0),
  revPct: CFG.revenues.map(()=>0),
  avgExpPct: [], avgRevPct: [], // pour r√©f√©rence agr√©g√©e
  count: 0,
  submitted:false
};

/* --------- UTILS ---------- */
const $ = sel => document.querySelector(sel);
const fmtM = n => (Math.round(n)).toLocaleString("fr-FR");
const fmtMd = n => {
  const sign = n<0 ? "-" : (n>0 ? "" : "");
  const abs = Math.round(Math.abs(n)/1000);
  return sign + abs.toLocaleString("fr-FR") + " Md‚Ç¨";
};
const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));
function toast(msg){ const el=$("#toast"); el.textContent=msg; el.style.display="block"; setTimeout(()=>{el.style.display="none"}, 2400); }

/* --------- CALCULS ---------- */
function compute(){
  const newExp = CFG.expenses.map((b,i)=> Math.round(b.base*(1+(b.locked?0:state.expPct[i])/100)) );
  const newRev = CFG.revenues.map((b,i)=> Math.round(b.base*(1+state.revPct[i]/100)) );
  const BASE_EXP = CFG.expenses.reduce((s,b)=>s+b.base,0);
  const BASE_REV = CFG.revenues.reduce((s,b)=>s+b.base,0);
  const baseDef = BASE_EXP - BASE_REV;

  const newExpM = newExp.reduce((s,x)=>s+x,0);
  const newRevM = newRev.reduce((s,x)=>s+x,0);
  const newDef = newExpM - newRevM;
  const savingM = baseDef - newDef;

  // Sommes positives/n√©gatives par famille (pour le texte clair)
  let expPos=0, expNeg=0;
  CFG.expenses.forEach((b,i)=>{
    const d = Math.round(b.base*(1+(b.locked?0:state.expPct[i])/100)) - b.base;
    if (d>0) expPos += d; else expNeg += d;
  });
  let revPos=0, revNeg=0;
  CFG.revenues.forEach((b,i)=>{
    const d = Math.round(b.base*(1+state.revPct[i]/100)) - b.base;
    if (d>0) revPos += d; else revNeg += d;
  });

  // Œî totaux sign√©s (centr√©s 0)
  const deltaExpTotal = newExpM - BASE_EXP; // <0 √©conomies
  const deltaRevTotal = newRevM - BASE_REV; // >0 recettes en plus

  return {BASE_EXP, BASE_REV, baseDef, newExp, newRev, newExpM, newRevM, newDeficitM:newDef, savingM,
    expPos, expNeg, revPos, revNeg, deltaExpTotal, deltaRevTotal};
}
function computeRefFromAverages(){
  const pctE = state.avgExpPct || [];
  const pctR = state.avgRevPct || [];
  const newExp = CFG.expenses.map((b,i)=> Math.round(b.base*(1+(b.locked?0:(pctE[i]||0))/100)) );
  const newRev = CFG.revenues.map((b,i)=> Math.round(b.base*(1+(pctR[i]||0)/100)) );
  const BASE_EXP = CFG.expenses.reduce((s,b)=>s+b.base,0);
  const BASE_REV = CFG.revenues.reduce((s,b)=>s+b.base,0);
  const newExpM = newExp.reduce((s,x)=>s+x,0);
  const newRevM = newRev.reduce((s,x)=>s+x,0);
  return {
    cutsExp: CFG.expenses.reduce((sum,b,i)=>{ const d = newExp[i]-b.base; return sum + (d<0 ? -d : 0); },0),
    incRev: CFG.revenues.reduce((sum,b,i)=>{ const d = newRev[i]-b.base; return sum + (d>0 ? d : 0); },0),
    deltaExpTotal: newExpM - BASE_EXP,
    deltaRevTotal: newRevM - BASE_REV
  };
}
function updateHUD(){
  const r = compute();
  const saving = r.savingM;
  const pct = clamp((saving/CFG.target.max)*100,0,100);
  const inRange = (saving>=CFG.target.min && saving<=CFG.target.max);
  $("#hudSaving").textContent = `${fmtM(saving)} M‚Ç¨`;
  $("#hudGap").textContent = inRange ? "OK (dans la cible)" :
    (saving < CFG.target.min ? `‚â•${fmtM(CFG.target.min - saving)} M‚Ç¨ √† trouver` : `‚â§${fmtM(saving - CFG.target.max)} M‚Ç¨ √† retirer`);
  $("#bar").style.width = pct+"%";
  $("#validateBtn").disabled = !inRange || state.submitted;
  $("#hud").classList.toggle("ok", inRange);
}

/* --------- UI RENDER (sliders) ---------- */
function renderBlock(container, list, kind){
  list.forEach((b,idx)=>{
    const row = document.createElement("div");
    row.className="row";
    const id=`${kind}_${idx}`;
    const disabledAttr = b.locked ? "disabled" : "";
    row.innerHTML = `
      <div class="label">${b.label}</div>
      ${b.info?`<div class="detailInfo">${b.info}</div>`:""}
      <div class="baseInfo">Base : ${Math.round(b.base/1000)} Md‚Ç¨</div>
      <div class="sliderWrap">
        <button class="nudge" data-id="${id}" data-d="-1" ${disabledAttr} aria-label="Diminuer ${b.label}">‚àí</button>
        <input type="range" id="${id}" min="${CFG.range.min}" max="${CFG.range.max}" step="1" ${b.locked?"value='0' disabled":"value='0'"} aria-label="${b.label}"/>
        <button class="nudge" data-id="${id}" data-d="+1" ${disabledAttr} aria-label="Augmenter ${b.label}">+</button>
      </div>
      <div class="valLine">
        <div><span id="${id}_pct">0</span>%</div>
        <div style="text-align:right">
          <div><strong><span id="${id}_new">${fmtM(b.base)}</span> M‚Ç¨</strong></div>
          <div class="delta" id="${id}_delta">0 M‚Ç¨</div>
        </div>
      </div>
    `;
    container.appendChild(row);

    const slider=row.querySelector(`#${id}`);
    const pctEl=row.querySelector(`#${id}_pct`);
    const newEl=row.querySelector(`#${id}_new`);
    const delEl=row.querySelector(`#${id}_delta`);

    const update=()=>{
      if (document.body.getAttribute('data-frozen')==="1") return; // s√©curit√©
      const pct=Number(slider.value)||0;
      if(kind==="exp") state.expPct[idx]=pct; else state.revPct[idx]=pct;
      const newVal = Math.round(b.base*(1+(b.locked?0:pct)/100));
      const delta  = newVal - b.base;
      pctEl.textContent = pct;
      newEl.textContent = fmtM(newVal);
      delEl.textContent = `${delta>=0?'+':''}${fmtM(delta)} M‚Ç¨`;
      const isExpense = (kind==="exp");
      const gain = isExpense ? (delta<0) : (delta>0);
      delEl.classList.toggle("gain", gain);
      delEl.classList.toggle("loss", !gain && delta!==0);
      updateHUD();
    };

    slider.addEventListener("input", update); update();

    if (!b.locked){
      let timer=null, stepper=null;
      const startRepeat = (dir)=>{
        if (document.body.getAttribute('data-frozen')==="1") return;
        const d = Number(dir);
        const tick = ()=>{
          const next = Math.max(CFG.range.min, Math.min(CFG.range.max, Number(slider.value)+d));
          if(Number(slider.value) !== next){ slider.value = String(next); update(); }
        };
        tick();
        let interval = 280;
        stepper = setInterval(()=>{ tick(); }, interval);
        timer = setTimeout(()=>{ clearInterval(stepper); interval=120; stepper=setInterval(()=>{tick();}, interval); }, 600);
      };
      const stopRepeat = ()=>{ if(timer){clearTimeout(timer);timer=null} if(stepper){clearInterval(stepper);stepper=null} };
      row.querySelectorAll(".nudge").forEach(btn=>{
        const dir = btn.dataset.d === "+1" ? +1 : -1;
        btn.addEventListener("pointerdown", (e)=>{ if(btn.hasAttribute('disabled')) return; e.preventDefault(); btn.setPointerCapture(e.pointerId); startRepeat(dir); });
        btn.addEventListener("pointerup",   ()=> stopRepeat());
        btn.addEventListener("pointercancel",()=> stopRepeat());
        btn.addEventListener("pointerleave", ()=> stopRepeat());
      });
    }
  });
}

/* --------- BACK (payload + envoi, SANS PR√âFLIGHT) ---------- */
function buildCompactPayload(){
  const r=compute();
  return {
    dataset:"Budget 2026 (base 2024) ‚Äî normalisation r√©pondant",
    unit:"M‚Ç¨",
    totals2024:{expenses:r.BASE_EXP, revenues:r.BASE_REV, deficit:r.baseDef},
    target:CFG.target, savingsM:r.savingM,
    e: state.expPct.slice(), r: state.revPct.slice(),
    newExpM:r.newExpM, newRevM:r.newRevM, newDeficitM:r.newDeficitM,
    meta:{ua:navigator.userAgent}, ts:new Date().toISOString()
  };
}
function postResponseNoPreflight(payloadObj){
  const params = new URLSearchParams({ payload: JSON.stringify(payloadObj) });
  // 1) Essai beacon (fiable iOS quand l‚Äôonglet bouge)
  try{
    const ok = navigator.sendBeacon(ENDPOINT_URL, new Blob([params.toString()], {type:'application/x-www-form-urlencoded;charset=UTF-8'}));
    if (ok) return;
  }catch(_){}
  // 2) Fallback fetch en form-urlencoded (pas d‚Äôen-t√™tes -> pas de pr√©flight)
  try{
    fetch(ENDPOINT_URL, { method:'POST', body: params }); // pas de await
  }catch(_){}
}

/* --------- VIOLINS (Plotly) ---------- */
const FIELD_MAP_EXP = [
  {id:"prot_soc", label:"Protection sociale", field:"E_prot_soc_delta_M‚Ç¨"},
  {id:"sante", label:"Sant√©", field:"E_sante_delta_M‚Ç¨"},
  {id:"education", label:"√âducation", field:"E_education_delta_M‚Ç¨"},
  {id:"serv_gen", label:"Services publics g√©n√©raux (hors int√©r√™ts dette)", field:"E_serv_gen_delta_M‚Ç¨"},
  {id:"aff_econ", label:"Affaires √©conomiques", field:"E_aff_econ_delta_M‚Ç¨"},
  {id:"defense", label:"D√©fense", field:"E_defense_delta_M‚Ç¨"},
  {id:"ordre_secu", label:"Ordre & s√©curit√© publics", field:"E_ordre_secu_delta_M‚Ç¨"},
  {id:"logement", label:"Logement & √©quipements collectifs", field:"E_logement_delta_M‚Ç¨"},
  {id:"environnement", label:"Environnement", field:"E_environnement_delta_M‚Ç¨"},
  {id:"culture", label:"Culture, loisirs et cultes", field:"E_culture_delta_M‚Ç¨"},
];
const FIELD_MAP_REV = [
  {id:"imp_prod", label:"Imp√¥ts sur la production et importations", field:"R_imp_prod_delta_M‚Ç¨"},
  {id:"cotis", label:"Cotisations sociales", field:"R_cotis_delta_M‚Ç¨"},
  {id:"ir", label:"Imp√¥t sur le revenu (IRPP)", field:"R_ir_delta_M‚Ç¨"},
  {id:"is", label:"Imp√¥t sur les soci√©t√©s", field:"R_is_delta_M‚Ç¨"},
  {id:"autres_rec", label:"Autres recettes", field:"R_autres_rec_delta_M‚Ç¨"},
];

function myDeltaForField(field){
  const isExp = field.startsWith("E_");
  if (isExp){
    const idx = CFG.expenses.findIndex(x => ("E_"+x.k+"_delta_M‚Ç¨") === field);
    if (idx<0) return 0;
    const base = CFG.expenses[idx].base;
    const pct  = CFG.expenses[idx].locked ? 0 : (state.expPct[idx]||0);
    const nv   = Math.round(base*(1+pct/100));
    return nv - base;
  }else{
    const idx = CFG.revenues.findIndex(x => ("R_"+x.k+"_delta_M‚Ç¨") === field);
    const base = CFG.revenues[idx].base;
    const pct  = (state.revPct[idx]||0);
    const nv   = Math.round(base*(1+pct/100));
    return nv - base;
  }
}

function drawViolinHybrid(divId, values, stats, myValueME, label){
  const violin = {
    type: "violin", orientation: "h",
    x: values.length? values : [0],
    y: values.map(_ => ""),
    name: label,
    points: "all", jitter: 0.6, scalemode: "count", pointpos: 0,
    marker: { size: 5, opacity: 0.35, color: "rgba(245,203,92,0.7)" },
    fillcolor: "rgba(245,203,92,0.25)", line: { color: "rgba(0,0,0,0)" },
    hovertemplate: "%{x:.0f} M‚Ç¨<extra></extra>"
  };
  const medianX = (typeof stats.median === "number") ? stats.median : 0;

  const min = Math.min(stats?.min ?? 0, myValueME ?? 0, medianX ?? 0, 0);
  const max = Math.max(stats?.max ?? 0, myValueME ?? 0, medianX ?? 0, 0);
  const margin = Math.max(10, (max - min) * 0.06);

  const shapes = [
    { type:"line", x0: medianX, x1: medianX, y0: -0.6, y1: 0.6, line:{ color:"#eab308", width:6 } },
    { type:"line", x0: myValueME, x1: myValueME, y0: -0.7, y1: 0.7, line:{ color:"#38bdf8", width:6 } },
    { type:"line", x0: 0, x1: 0, y0: -0.8, y1: 0.8, line:{ color:"rgba(148,163,184,0.45)", width:2, dash:"dot" } }
  ];
  const annotations = [
    { x: myValueME, y: 0.75, text: "Vous : " + fmtM(myValueME) + " M‚Ç¨", showarrow:true, arrowhead:6, ax:0, ay:-35,
      font:{color:"#38bdf8",size:12}, bgcolor:"rgba(56,189,248,0.08)", bordercolor:"#38bdf8" },
    { x: medianX, y: -0.75, text: "M√©diane : " + fmtM(medianX) + " M‚Ç¨", showarrow:true, arrowhead:6, ax:0, ay:35,
      font:{color:"#eab308",size:12}, bgcolor:"rgba(234,179,8,0.08)", bordercolor:"#eab308" }
  ];

  const layout = {
    paper_bgcolor:"#111827", plot_bgcolor:"#111827", font:{color:"#e2e8f0"},
    margin:{l:10,r:10,t:28,b:46},
    title:{ text: label, x:0, xanchor:"left", y:0.98, font:{size:14} },
    xaxis:{ title:"Variation (en M‚Ç¨)", gridcolor:"#334155", zerolinecolor:"#334155",
            range:[ min - margin, max + margin ], tickformat:",.0f" },
    yaxis:{ showticklabels:false },
    shapes, annotations, hovermode:"x unified", showlegend:false
  };
  const isMobile = window.matchMedia("(max-width: 520px)").matches;
  const config = { responsive:true, displayModeBar:false, staticPlot:isMobile };
  Plotly.newPlot(divId, [violin], layout, config);
}

/* --------- R√âSULTATS (un seul GET + rendu progressif) ---------- */
async function fetchAllDistributions(){
  try{
    const url = ENDPOINT_URL + "?action=violins";
    const r = await fetch(url, {method:"GET", cache:"no-cache"});
    const j = await r.json();
    if (j && j.ok && j.fields) return j.fields;
  }catch(e){}
  return null;
}
async function renderAllViolinsProgressive(){
  const expWrap = $("#violins-expenses");
  const revWrap = $("#violins-revenues");
  expWrap.innerHTML=""; revWrap.innerHTML="";

  const allMaps = [...FIELD_MAP_EXP, ...FIELD_MAP_REV];
  allMaps.forEach(m=>{
    const div = document.createElement("div");
    div.id = "v-" + m.id;
    div.style.height = "280px";
    div.style.background = "rgba(255,255,255,.02)";
    div.style.border = "1px dashed #2a3c64";
    div.style.borderRadius = "10px";
    div.style.padding = "6px";
    (FIELD_MAP_EXP.includes(m) ? expWrap : revWrap).appendChild(div);
  });

  const all = await fetchAllDistributions();
  if (!all){ // fallback si agr√©gateur indispo
    // Ne rien planter, juste laisser des blocs vides.
    return;
  }

  const jobs = allMaps.map(m=>({m,divId:"v-"+m.id, data: all[m.field] || {values:[],stats:{}} }));
  const firstWave = jobs.slice(0,4);
  await Promise.all(firstWave.map(async (j)=>{
    const myVal = myDeltaForField(j.m.field);
    drawViolinHybrid(j.divId, j.data.values||[], j.data.stats||{}, myVal, j.m.label);
  }));

  const rest = jobs.slice(4);
  for (const j of rest){
    const myVal = myDeltaForField(j.m.field);
    drawViolinHybrid(j.divId, j.data.values||[], j.data.stats||{}, myVal, j.m.label);
    await new Promise(r=>setTimeout(r, 30));
  }
}

/* --------- BARRES totales centr√©es sur 0 ---------- */
function pctInDomain(val, min, max){ if (max===min) return 50; return Math.max(0, Math.min(100, ((val - min) / (max - min)) * 100)); }
function renderBarsZero(expYou, expRef, revYou, revRef){
  const vals = [expYou, expRef, revYou, revRef, 0].filter(v=>typeof v==="number" && isFinite(v));
  const span = Math.max(...vals) - Math.min(...vals);
  const pad = Math.max(5, span * 0.15);
  const dmin = Math.min(...vals) - pad;
  const dmax = Math.max(...vals) + pad;

  const setPos = (id,val)=>{ $(id).style.left = pctInDomain(val, dmin, dmax) + "%"; };
  setPos("#barExpZero", 0); setPos("#barExpYou", expYou); setPos("#barExpRef", expRef);
  setPos("#barRevZero", 0); setPos("#barRevYou", revYou); setPos("#barRevRef", revRef);

  $("#barExpTitle").innerHTML = "<strong>Variation totale des d√©penses (M‚Ç¨)</strong> ‚Äî <span style='color:var(--you);font-weight:700'>Vous (" + (expYou>=0?"+":"") + fmtM(expYou) + " M‚Ç¨)</span>, <span style='color:var(--ref);font-weight:700'>M√©diane (" + (expRef>=0?"+":"") + fmtM(expRef) + " M‚Ç¨)</span>";
  $("#barRevTitle").innerHTML = "<strong>Variation totale des recettes (M‚Ç¨)</strong> ‚Äî <span style='color:var(--you);font-weight:700'>Vous (" + (revYou>=0?"+":"") + fmtM(revYou) + " M‚Ç¨)</span>, <span style='color:var(--ref);font-weight:700'>M√©diane (" + (revRef>=0?"+":"") + fmtM(revRef) + " M‚Ç¨)</span>";
}

/* --------- SYNTH√àSE (texte clair + barres par poste) ---------- */
function buildListItems(kind, items, maxItems=9999){
  const modified = items.filter(d=>d.delta!==0).sort((a,b)=> Math.abs(b.delta) - Math.abs(a.delta));
  const container = kind==="exp" ? $("#sumExpList") : $("#sumRevList");
  container.innerHTML = "";

  if (!modified.length){
    const small = document.createElement("div");
    small.className="hint";
    small.textContent = "Aucune variation sur cette section.";
    container.appendChild(small);
    return;
  }

  const allVals = modified.map(d=>d.delta).concat([0]);
  const min = Math.min(...allVals);
  const max = Math.max(...allVals);

  function addItem(it){
    const row = document.createElement("div");
    row.className="item";
    row.innerHTML = `<div class="itemLabel">${it.label}</div><div class="itemVal">${(it.delta>=0?"+":"")}${fmtM(it.delta)} M‚Ç¨</div>`;
    const bar = document.createElement("div");
    bar.className="barLine"; bar.setAttribute("aria-hidden","true");

    const seg = document.createElement("div");
    seg.className="barSeg " + ((kind==="exp" ? it.delta<0 : it.delta>0) ? "segGood":"segBad");
    const zeroPct = pctInDomain(0, min, max);
    const valPct  = pctInDomain(it.delta, min, max);
    const left = Math.min(zeroPct, valPct);
    const width = Math.abs(valPct - zeroPct);
    seg.style.left = left + "%";
    seg.style.width = Math.max(2, width) + "%";

    const zero = document.createElement("div");
    zero.className = "barZero";
    zero.style.left = zeroPct + "%";

    bar.appendChild(seg);
    bar.appendChild(zero);

    const wrap = document.createElement("div");
    wrap.appendChild(bar);
    row.appendChild(wrap);
    container.appendChild(row);
  }

  modified.slice(0,maxItems).forEach(addItem);
}

function buildSummary(){
  const r = compute();
  const inRange = (r.savingM>=CFG.target.min && r.savingM<=CFG.target.max);
  $("#targetBadge").textContent = inRange ? "Dans la cible" : "Hors cible";

  // Texte clair avec sommes positif/n√©gatif
  const depTxt = r.deltaExpTotal<0
    ? `Vous avez <strong>r√©duit</strong> les d√©penses de <strong>${fmtMd(r.deltaExpTotal)}</strong>.`
    : r.deltaExpTotal>0
      ? `Vous avez <strong>augment√©</strong> les d√©penses de <strong>${fmtMd(r.deltaExpTotal)}</strong>.`
      : `Vous n‚Äôavez pas modifi√© le total des d√©penses.`;

  const recTxt = r.deltaRevTotal>0
    ? `Vous avez <strong>augment√©</strong> les recettes de <strong>${fmtMd(r.deltaRevTotal)}</strong>.`
    : r.deltaRevTotal<0
      ? `Vous avez <strong>r√©duit</strong> les recettes de <strong>${fmtMd(r.deltaRevTotal)}</strong>.`
      : `Vous n‚Äôavez pas modifi√© le total des recettes.`;

  $("#sumHeadline").innerHTML = `üéØ ${depTxt} ${recTxt} Globalement, vous r√©duisez le d√©ficit de <strong>${fmtMd(r.savingM)}</strong>.`;

  const expDeltas = CFG.expenses.map((b,i)=>({label:b.label, delta: Math.round(b.base*(1+(b.locked?0:state.expPct[i])/100)) - b.base}));
  const revDeltas = CFG.revenues.map((b,i)=>({label:b.label, delta: Math.round(b.base*(1+state.revPct[i]/100)) - b.base}));

  $("#listTitleExp").innerHTML = "D√©penses ‚Äî variations par poste";
  $("#listTitleRev").innerHTML = "Recettes ‚Äî variations par poste";
  buildListItems("exp", expDeltas);
  buildListItems("rev", revDeltas);
}

/* --------- PARTAGE ---------- */
async function shareSummary(){
  try{
    const r = compute();
    const textOnly = `J‚Äôai r√©ussi √† trouver ${fmtMd(r.savingM)} pour le budget de la France sur ce simulateur. Et toi ? ${SHARE_URL}`;

    // iOS/Safari : texte + lien uniquement (√©vite les ouvertures d‚Äôonglet)
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    if (navigator.share){
      if (isIOS){
        await navigator.share({ text: textOnly, title:"The805Lab - Simulateur Budget" });
        return;
      }
      // Android/desktop compatible : on essaie l‚Äôimage, sinon texte seul
      try{
        const pngBlob = await buildSummaryPNG();
        const file = new File([pngBlob], "budgetlab-mes-resultats.png", {type:"image/png"});
        if (navigator.canShare && navigator.canShare({ files:[file] })){
          await navigator.share({ files:[file], text:textOnly, title:"The805Lab - Simulateur Budget" });
          return;
        }
      }catch(_){}
      await navigator.share({ text:textOnly, title:"The805Lab - Simulateur Budget" });
      return;
    }
    // Fallback : copie dans le presse-papier + toast
    try{ await navigator.clipboard.writeText(textOnly); toast("Message copi√©. Collez-le dans votre app de messagerie."); }
    catch(_){ toast("Partage non support√©. Copiez/collez ce message : " + textOnly); }
  }catch(e){
    console.error(e);
    toast("Partage indisponible sur cet appareil.");
  }
}

// G√©n√©ration PNG (utilis√© uniquement si partage fichiers possible)
async function buildSummaryPNG(){
  const r = compute();
  const title = `J‚Äôai trouv√© ${fmtM(r.savingM)} M‚Ç¨ d‚Äô√©conomies pour la France`;
  const subtitle = `en ajustant d√©penses et recettes (Budget 2026, base 2024)`;
  const expDeltas = CFG.expenses.map((b,i)=>({label:b.label, delta: Math.round(b.base*(1+(b.locked?0:state.expPct[i])/100)) - b.base}))
                    .sort((a,b)=>Math.abs(b.delta)-Math.abs(a.delta)).slice(0,8);
  const revDeltas = CFG.revenues.map((b,i)=>({label:b.label, delta: Math.round(b.base*(1+state.revPct[i]/100)) - b.base}))
                    .sort((a,b)=>Math.abs(b.delta)-Math.abs(a.delta)).slice(0,8);

  const W=1200, H=800, pad=40;
  const svgParts=[];
  svgParts.push(`<svg xmlns="http://www.w3.org/2000/svg" width="${W}" height="${H}" viewBox="0 0 ${W} ${H}">
    <rect width="100%" height="100%" fill="#0b1730"/>
    <style>.t{fill:#E8F0FF;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}</style>
    <text x="${pad}" y="${pad+16}" class="t" font-size="28" font-weight="700">${title}</text>
    <text x="${pad}" y="${pad+46}" class="t" font-size="18" opacity=".8">${subtitle}</text>
  `);
  function addList(x,y,title,list,isExp){
    svgParts.push(`<text x="${x}" y="${y}" class="t" font-size="20" font-weight="700">${title}</text>`);
    const y0 = y+16;
    const lineH=26, barH=12, top= y0+8;
    const vals = list.map(d=>d.delta).concat([0]);
    const min = Math.min(...vals), max=Math.max(...vals);
    function xpct(v){ if(max===min) return 0.5; return (v-min)/(max-min); }
    for(let i=0;i<list.length;i++){
      const d = list[i];
      const yy = top + i*lineH;
      svgParts.push(`<text x="${x}" y="${yy}" class="t" font-size="16" opacity=".95">${d.label}</text>`);
      const gx = x, gw = 480, gy = yy+6, gh=barH;
      svgParts.push(`<rect x="${gx}" y="${gy}" width="${gw}" height="${gh}" fill="#0b1633" stroke="#233047"/>`);
      const z = xpct(0), v = xpct(d.delta);
      const left = Math.min(z,v), right=Math.max(z,v);
      const ww = Math.max(2,(right-left)*gw);
      const xx = gx + left*gw;
      const good = isExp ? (d.delta<0) : (d.delta>0);
      const color = good ? "#16a34a" : "#ef4444";
      svgParts.push(`<rect x="${xx}" y="${gy}" width="${ww}" height="${gh}" fill="${color}"/>`);
      svgParts.push(`<text x="${gx+gw+10}" y="${gy+gh-2}" class="t" font-size="14" opacity=".9">${d.delta>=0?'+':''}${fmtM(d.delta)} M‚Ç¨</text>`);
    }
  }
  addList(pad, 120, "D√©penses ‚Äî variations par poste", expDeltas, true);
  addList(W/2+pad/2, 120, "Recettes ‚Äî variations par poste", revDeltas, false);
  svgParts.push(`</svg>`);
  const svg = svgParts.join("");

  const svgBlob = new Blob([svg], {type:'image/svg+xml'});
  const url = URL.createObjectURL(svgBlob);
  const img = new Image();
  await new Promise((resolve,reject)=>{
    img.onload = resolve; img.onerror = reject; img.src = url;
    if ('decode' in img) { img.decode().then(resolve).catch(()=>{}); }
  });
  const canvas = document.createElement('canvas');
  canvas.width = W; canvas.height = H;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(img,0,0);
  URL.revokeObjectURL(url);

  let pngBlob = await new Promise(resolve=>{
    try{ canvas.toBlob(b=>resolve(b||null),"image/png",0.92); }catch(_){ resolve(null); }
  });
  if(!pngBlob){
    const dataURL = canvas.toDataURL("image/png",0.92);
    const bstr = atob(dataURL.split(',')[1]);
    const mime = dataURL.split(',')[0].split(':')[1].split(';')[0];
    const ia = new Uint8Array(bstr.length);
    for (let i=0;i<bstr.length;i++) ia[i]=bstr.charCodeAt(i);
    pngBlob = new Blob([ia],{type:mime});
  }
  return pngBlob;
}

/* --------- VALIDATE ---------- */
async function onValidate(){
  const validateBtn = $("#validateBtn");
  const editBtn = $("#editBtn");
  const shareBtn = $("#shareBtn");
  state.submitted = true;
  document.body.setAttribute('data-frozen','1');
  validateBtn.disabled = true;
  editBtn.style.display = "inline-flex";
  shareBtn.style.display = "inline-flex";

  // POST fire-and-forget (no preflight)
  postResponseNoPreflight(buildCompactPayload());

  // Affiche synth√®se imm√©diatement puis comparaison
  $("#summary").style.display="block";
  buildSummary();

  // Nettoyer la ligne sous le bouton (retirer le message)
  $("#validateHint").textContent = "";

  // R√©cup√®re r√©f√©rence (moyennes) + count puis affiche barres et violons
  try{
    const statsRes = await fetch(ENDPOINT_URL + "?stats=1", {method:"GET", cache:"no-cache"});
    const stats = await statsRes.json();
    if(stats && stats.ok){
      state.avgExpPct = stats.avgExpPct || [];
      state.avgRevPct = stats.avgRevPct || [];
      state.count = stats.count || 0;
      $("#ansCountLine").textContent = `R√©ponses enregistr√©es : ${state.count.toLocaleString("fr-FR")}`;
    } else {
      $("#ansCountLine").textContent = `R√©ponses enregistr√©es : ‚Äî`;
    }
  }catch(_){
    $("#ansCountLine").textContent = `R√©ponses enregistr√©es : ‚Äî`;
  }

  // Mise √† jour num√©rique (totaux) + barres 0
  const you = compute();
  const ref  = computeRefFromAverages();
  $("#results").style.display="block";
  renderBarsZero(you.deltaExpTotal, ref.deltaExpTotal || 0, you.deltaRevTotal, ref.deltaRevTotal || 0);

  // Violons en progressif (un seul GET)
  await renderAllViolinsProgressive();
}

function onEdit(){
  state.submitted = false;
  document.body.removeAttribute('data-frozen');
  $("#validateBtn").disabled = false;
  $("#editBtn").style.display = "none";
  $("#validateHint").textContent="Modifiez vos curseurs puis revalidez.";
}

/* --------- INIT ---------- */
function init(){
  renderBlock($("#expContainer"), CFG.expenses, "exp");
  renderBlock($("#revContainer"), CFG.revenues, "rev");
  updateHUD();
  $("#validateBtn").addEventListener("click", onValidate);
  $("#editBtn").addEventListener("click", onEdit);
  $("#shareBtn").addEventListener("click", shareSummary);
}
document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
