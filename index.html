<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>BudgetLab — Trouver 40 Md€ pour le budget 2026</title>

<!-- Plotly pour les distributions -->
<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>

<style>
  :root{
    --bg:#0a1022; --panel:#0f1a33; --panel2:#0b1530; --ring:#21315a;
    --text:#e8f0ff; --muted:#a7b5cf;
    --ok:#16a34a; --bad:#ef4444;
    --expBg:#0e254f; --revBg:#0b1f45;
    --chip:#0c1636; --brand:#2563eb;
    --accent:#3b82f6;
    --you:#38bdf8; /* bleu clair "Vous" */
    --ref:#eab308; /* jaune "Médiane" */
    --axis:#94a3b8;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;touch-action:pan-y}
  .wrap{max-width:980px;margin:0 auto;padding:16px}
  h1{margin:0 0 6px;font-size:1.22rem;line-height:1.25}
  .subtitle{color:var(--muted);font-size:.92rem;margin-bottom:10px}
  .bar{height:10px;background:#1a2746;border-radius:999px;overflow:hidden;margin:8px 0 14px}
  .bar>span{display:block;height:100%;background:linear-gradient(90deg,#dc2626,#eab308,#16a34a);width:0%}

  .card{background:var(--panel);border:1px solid var(--ring);border-radius:14px;padding:14px;margin:12px 0}
  .section{border-radius:16px;border:1px solid var(--ring);margin:14px 0; overscroll-behavior:contain; overflow:visible;}
  .section.exp{background:var(--expBg)} .section.rev{background:var(--revBg)}
  .head{padding:12px 14px;background:rgba(255,255,255,.05);display:flex;gap:12px;align-items:center;font-weight:700;flex-wrap:wrap}
  .badge{padding:2px 8px;border-radius:999px;border:1px solid var(--ring);background:#0b152f;color:#dce7ff;font-size:.8rem}
  .row{padding:12px 14px;border-top:1px dashed #274067}
  .label{font-weight:700} .hint{color:var(--muted);font-size:.9rem;margin-top:2px}

  .sliderWrap{display:grid;grid-template-columns:42px 1fr 42px;gap:8px;align-items:center}
  .nudge{width:42px;height:42px;border-radius:12px;border:1px solid var(--ring);background:#0b1633;color:#cfe1ff;cursor:pointer;font-weight:700;font-size:1rem;touch-action:manipulation}
  .nudge:active{transform:scale(.98)}
  .nudge[disabled]{opacity:.4;cursor:not-allowed}
  input[type=range]{width:100%;margin:8px 0;height:36px;touch-action:pan-y}
  input[type=range]::-webkit-slider-runnable-track{height:10px;background:#2a3c69;border-radius:999px}
  input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;margin-top:-7px;width:26px;height:26px;border-radius:50%;background:var(--brand);border:2px solid #a5b4fc}
  input[type=range]::-moz-range-track{height:10px;background:#2a3c69;border-radius:999px}
  input[type=range]::-moz-range-thumb{width:24px;height:24px;border:none;border-radius:50%;background:var(--brand)}
  input[type=range][disabled]{opacity:.5}

  .valLine{display:flex;justify-content:space-between;gap:8px;margin-top:6px;align-items:center}
  .delta{font-variant-numeric:tabular-nums}
  .delta.gain{color:var(--ok)} .delta.loss{color:var(--bad)}

  /* HUD flottant code couleur (bord à gauche) */
  .floatBubble{
    position:fixed; right:14px; bottom:14px; z-index:50;background:#0b172f;border:1px solid var(--ring);
    border-radius:12px; padding:10px 12px;box-shadow:0 6px 24px rgba(0,0,0,.35); font-size:.95rem;
    border-left:6px solid var(--bad);
  }
  .floatBubble.ok{ border-left-color: var(--ok); }
  .floatBubble strong{color:#fff}

  .btn{display:inline-flex;gap:.6rem;align-items:center;background:var(--brand);color:#fff;border:0;border-radius:12px;padding:14px 16px;cursor:pointer;font-weight:700;font-size:1.02rem}
  .btn:disabled{background:#334155;color:#94a3b8;cursor:not-allowed}
  .btn.wide{width:100%} @media (min-width:760px){.btn.wide{width:auto;padding:12px 18px}}

  .results{display:none}
  .legend{color:var(--muted);font-size:.9rem;margin:6px 0 8px}

  /* Grille des violons */
  .violinsGrid{display:grid;grid-template-columns:1fr;gap:12px}
  @media (min-width:760px){.violinsGrid{grid-template-columns:1fr 1fr}}

  .footer{color:var(--muted);font-size:.85rem;margin-top:16px}
  .toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:#0b172f;border:1px solid var(--ring);color:#e6f0ff;border-radius:10px;padding:10px 12px;box-shadow:0 6px 20px rgba(0,0,0,.35);z-index:60;display:none}

  /* Overlay chargement */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:80}
  .overlay.show{display:flex}
  .loader{background:#0b1633;border:1px solid var(--ring);border-radius:12px;padding:14px 16px;box-shadow:0 10px 24px rgba(0,0,0,.4);min-width:280px;text-align:center}
  .spinner{width:18px;height:18px;border:3px solid #334155;border-top-color:var(--accent);border-radius:50%;display:inline-block;animation:spin 1s linear infinite;margin-right:8px;vertical-align:middle}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* Barres comparatives — centrées sur 0 */
  .barbox{background:var(--panel2);border:1px solid var(--ring);border-radius:12px;padding:12px}
  .barline{position:relative;height:14px;border:1px solid #233047;border-radius:999px;background:#0b1633}
  .barlegend{display:flex;justify-content:space-between;font-size:.9rem;color:#cbd5e1;margin-top:6px}
  .mark{position:absolute;top:-6px;width:3px;height:26px;border-radius:2px}
  .mark.you{background:var(--you)}
  .mark.ref{background:var(--ref)}
  .mark.zero{background:rgba(148,163,184,.45); width:2px; top:-5px; height:24px}
  .actionsRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
</style>
</head>
<body>

<!-- Overlay -->
<div class="overlay" id="overlay">
  <div class="loader">
    <div><span class="spinner"></span><strong>Vos résultats sont en cours de traitement…</strong></div>
    <div class="subtitle" style="margin-top:6px">Quelques secondes suffisent.</div>
  </div>
</div>

<div class="wrap">
  <h1>À vous de trouver <strong>40 Md€</strong> pour le budget 2026 (France)</h1>

  <!-- Intro pédagogique (allégée) -->
  <div class="card" style="background:#0b1935;border-color:#1e2d55;">
    <div class="subtitle" style="color:#d9e3ff">
      En 2024, la France affichait un déficit d’environ <strong>170&nbsp;Md€</strong> (≈&nbsp;5,8&nbsp;% du PIB).
      L’Union européenne vise un retour vers <strong>3&nbsp;% du PIB</strong> d’ici les prochaines années.
      Ici, vous jouez au ministre du budget : ajustez des <strong>dépenses</strong> et/ou des <strong>recettes</strong>
      pour atteindre un jalon simple et parlant, autour de <strong>40&nbsp;Md€</strong> d’effort. Validez, puis comparez votre scénario aux autres.
    </div>
  </div>

  <div class="bar"><span id="bar"></span></div>

  <!-- Dépenses -->
  <div class="section exp">
    <div class="head">Dépenses <span class="badge">curseurs −15 % à +15 %</span></div>
    <div id="expContainer"></div>
  </div>

  <!-- Recettes -->
  <div class="section rev">
    <div class="head">Recettes <span class="badge">curseurs −15 % à +15 %</span></div>
    <div id="revContainer"></div>
  </div>

  <!-- Actions -->
  <div class="card">
    <div class="actionsRow">
      <button id="validateBtn" class="btn wide" disabled>Valider mon budget</button>
      <button id="editBtn" class="btn" style="display:none;background:#334155">Modifier mon scénario</button>
    </div>
    <div class="hint" id="validateHint" style="margin-top:6px;">Le bouton s’active quand l’économie est entre 40 000 et 45 000 M€.</div>
  </div>

  <!-- Résultats -->
  <div id="results" class="card results">
    <h2 style="margin:0 0 10px;font-size:1.06rem">Mes résultats — comparaison normalisée</h2>
    <div class="hint" id="ansCountLine" style="margin:-2px 0 8px;color:#cbd5e1"></div>

    <!-- Résumé haut : barres centrées sur 0 -->
    <div class="barbox">
      <div class="hint" style="margin-bottom:6px"><strong>Variation des dépenses (M€)</strong> — <span style="color:var(--you);font-weight:700">Vous</span> vs <span style="color:var(--ref);font-weight:700">médiane</span> (0 = inchangé)</div>
      <div class="barline" id="barExpLine">
        <div class="mark zero" id="barExpZero" style="left:50%"></div>
        <div class="mark ref"  id="barExpRef"  style="left:50%"></div>
        <div class="mark you"  id="barExpYou"  style="left:50%"></div>
      </div>
      <div class="barlegend"><span id="barExpYouVal">Vous : —</span><span id="barExpRefVal">Médiane : —</span></div>
    </div>

    <div class="barbox" style="margin-top:10px">
      <div class="hint" style="margin-bottom:6px"><strong>Variation des recettes (M€)</strong> — <span style="color:var(--you);font-weight:700">Vous</span> vs <span style="color:var(--ref);font-weight:700">médiane</span> (0 = inchangé)</div>
      <div class="barline" id="barRevLine">
        <div class="mark zero" id="barRevZero" style="left:50%"></div>
        <div class="mark ref"  id="barRevRef"  style="left:50%"></div>
        <div class="mark you"  id="barRevYou"  style="left:50%"></div>
      </div>
      <div class="barlegend"><span id="barRevYouVal">Vous : —</span><span id="barRevRefVal">Médiane : —</span></div>
    </div>

    <!-- Texte résumé -->
    <div class="card" style="background:#0b1935;border-color:#1e2d55;margin-top:12px">
      <div style="display:grid;grid-template-columns:1fr;gap:8px">
        <div><strong>Votre réduction de dépenses :</strong> <span id="sumCutsYou">0</span> M€ &nbsp;|&nbsp; <span style="color:#a7b5cf">Référence :</span> <span id="sumCutsAvg">0</span> M€</div>
        <div><strong>Votre variation de recettes :</strong> <span id="sumIncYou">0</span> M€ &nbsp;|&nbsp; <span style="color:#a7b5cf">Référence :</span> <span id="sumIncAvg">0</span> M€</div>
      </div>
    </div>

    <div class="legend" id="normNote">
      Chaque graphique montre la distribution des réponses (variation en M€ vs 2024), votre valeur (bleu) et la médiane (jaune).
    </div>

    <div class="section exp" style="margin-top:10px">
      <div class="head">Dépenses — variation (M€)</div>
      <div id="violins-expenses" class="violinsGrid"></div>
    </div>
    <div class="section rev" style="margin-top:10px">
      <div class="head">Recettes — variation (M€)</div>
      <div id="violins-revenues" class="violinsGrid"></div>
    </div>
  </div>

  <div class="footer">
    Sources : Insee (APU), Ministère de l’Économie, Commission européenne. Chiffres 2024 arrondis. Certains postes sont difficiles à ajuster à court terme (ex. intérêts de la dette).
  </div>
</div>

<!-- Bulle flottante permanente -->
<div id="hud" class="floatBubble">
  <div>Économie : <strong id="hudSaving">0 M€</strong></div>
  <div style="color:var(--muted)">Écart : <strong id="hudGap">≥40 000 M€</strong></div>
</div>

<div id="toast" class="toast"></div>

<script>
/* --------- CONFIG ---------- */
const ENDPOINT_URL = "https://script.google.com/macros/s/AKfycbxHnolZm-C31zBPKrg7sWLNLGD9PELL5en5OBDjGuDjPvgZydE_cY_WoNv7Q_-ms8Ur/exec";

const CFG = {
  target:{min:40000, max:45000},
  expenses: [
    {k:"prot_soc",label:"Protection sociale",base:701400,locked:false,info:"Retraites, assurance chômage, minima sociaux, prestations familiales."},
    {k:"sante",label:"Santé",base:250500,locked:false,info:"Hôpitaux, soins, médicaments, prévention, santé publique."},
    {k:"education",label:"Éducation",base:167000,locked:false,info:"Écoles, collèges, lycées, universités, vie étudiante."},
    {k:"serv_gen",label:"Services publics généraux (hors intérêts de la dette)",base:120000,locked:false,info:"État, administrations centrales, coordination, R&D générale."},
    {k:"interets_dette",label:"Charges d’intérêts de la dette (non modifiable)",base:58700,locked:true,info:"Service de la dette (verrouillé)."},
    {k:"aff_econ",label:"Affaires économiques",base:167000,locked:false,info:"Transports, agriculture, énergie, industrie, emploi/investissement."},
    {k:"defense",label:"Défense",base:75200,locked:false,info:"Armée, équipements, opérations, dissuasion, maintenance."},
    {k:"ordre_secu",label:"Ordre & sécurité publics",base:50100,locked:false,info:"Police, gendarmerie, justice pénale, prisons, sécurité civile."},
    {k:"logement",label:"Logement & équipements collectifs",base:30100,locked:false,info:"Aides au logement, urbanisme, infrastructures locales."},
    {k:"environnement",label:"Protection de l’environnement",base:30100,locked:false,info:"Déchets, eau, air, biodiversité, climat."},
    {k:"culture",label:"Culture, loisirs et cultes",base:20000,locked:false,info:"Culture, sport, patrimoine, bibliothèques, cultes."},
  ],
  revenues: [
    {k:"imp_prod",label:"Impôts sur la production et importations",base:570000,info:"TVA, taxes sur produits/consommations, droits de douane."},
    {k:"cotis",label:"Cotisations sociales",base:480000,info:"Cotisations employeurs/salariés (retraites, santé, chômage)."},
    {k:"ir",label:"Impôt sur le revenu",base:120000,info:"IRPP, prélèvement à la source, acomptes."},
    {k:"is",label:"Impôt sur les sociétés",base:80000,info:"Impôt sur les bénéfices des entreprises."},
    {k:"autres_rec",label:"Autres recettes",base:252000,info:"Dividendes/recettes patrimoniales, amendes, redevances, divers."},
  ],
  range:{min:-15,max:15}
};

/* --------- STATE ---------- */
const state = {
  expPct: CFG.expenses.map(()=>0),
  revPct: CFG.revenues.map(()=>0),
  avgExpPct: [], avgRevPct: [], // pour référence agrégée
  count: 0,
  submitted:false
};

/* --------- UTILS ---------- */
const fmtM = n => (Math.round(n)).toLocaleString("fr-FR");
const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));
function toast(msg){ const el=document.getElementById("toast"); el.textContent=msg; el.style.display="block"; setTimeout(()=>{el.style.display="none"}, 2400); }
const $ = (sel)=> document.querySelector(sel);

/* --------- OPTION A (clé + hash) ---------- */
function ensureUserKey(){
  const k = localStorage.getItem("user_key_v1");
  if (k) return k;
  const key = (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now())+"_"+Math.random().toString(16).slice(2);
  localStorage.setItem("user_key_v1", key);
  return key;
}
function stableStringify(obj){
  const sort = v => Array.isArray(v) ? v.map(sort) : (v && typeof v==="object" ? Object.keys(v).sort().reduce((a,k)=> (a[k]=sort(v[k]),a),{}) : v);
  return JSON.stringify(sort(obj));
}
async function sha256Hex(str){
  const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(str));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
}

/* --------- CALCULS ---------- */
function compute(){
  const newExp = CFG.expenses.map((b,i)=> Math.round(b.base*(1+(b.locked?0:state.expPct[i])/100)) );
  const newRev = CFG.revenues.map((b,i)=> Math.round(b.base*(1+state.revPct[i]/100)) );
  const BASE_EXP = CFG.expenses.reduce((s,b)=>s+b.base,0);
  const BASE_REV = CFG.revenues.reduce((s,b)=>s+b.base,0);
  const baseDef = BASE_EXP - BASE_REV;

  const newExpM = newExp.reduce((s,x)=>s+x,0);
  const newRevM = newRev.reduce((s,x)=>s+x,0);
  const newDef = newExpM - newRevM;
  const savingM = baseDef - newDef;

  // Δ totaux signés (centrés sur 0)
  const deltaExpTotal = newExpM - BASE_EXP; // <0 = économies
  const deltaRevTotal = newRevM - BASE_REV; // >0 = recettes en plus

  // Décompositions (positif strict) pour le petit résumé texte
  const cutsExp = CFG.expenses.reduce((sum,b,i)=>{
    const d = Math.round(b.base*(1+(b.locked?0:state.expPct[i])/100)) - b.base;
    return sum + (d<0 ? -d : 0);
  },0);
  const incRev = CFG.revenues.reduce((sum,b,i)=>{
    const d = Math.round(b.base*(1+state.revPct[i]/100)) - b.base;
    return sum + (d>0 ? d : 0);
  },0);

  return {BASE_EXP, BASE_REV, baseDef, newExp, newRev, newExpM, newRevM, newDeficitM:newDef, savingM, cutsExp, incRev, deltaExpTotal, deltaRevTotal};
}
function computeRefFromAverages(){
  const pctE = state.avgExpPct || [];
  const pctR = state.avgRevPct || [];
  const newExp = CFG.expenses.map((b,i)=> Math.round(b.base*(1+(b.locked?0:(pctE[i]||0))/100)) );
  const newRev = CFG.revenues.map((b,i)=> Math.round(b.base*(1+(pctR[i]||0)/100)) );
  const BASE_EXP = CFG.expenses.reduce((s,b)=>s+b.base,0);
  const BASE_REV = CFG.revenues.reduce((s,b)=>s+b.base,0);
  const newExpM = newExp.reduce((s,x)=>s+x,0);
  const newRevM = newRev.reduce((s,x)=>s+x,0);
  return {
    cutsExp: CFG.expenses.reduce((sum,b,i)=>{
      const d = newExp[i]-b.base; return sum + (d<0 ? -d : 0);
    },0),
    incRev: CFG.revenues.reduce((sum,b,i)=>{
      const d = newRev[i]-b.base; return sum + (d>0 ? d : 0);
    },0),
    deltaExpTotal: newExpM - BASE_EXP,
    deltaRevTotal: newRevM - BASE_REV
  };
}
function updateHUD(){
  const r = compute();
  const saving = r.savingM;
  const pct = clamp((saving/CFG.target.max)*100,0,100);
  const inRange = (saving>=CFG.target.min && saving<=CFG.target.max);

  $("#hudSaving").textContent = `${fmtM(saving)} M€`;
  let gapText;
  if (!inRange){
    if (saving < CFG.target.min) gapText = `≥${fmtM(CFG.target.min - saving)} M€ à trouver`;
    else gapText = `≤${fmtM(saving - CFG.target.max)} M€ à retirer`;
  } else gapText = "OK (dans la cible)";
  $("#hudGap").textContent = gapText;

  document.getElementById("bar").style.width = pct+"%";
  document.getElementById("validateBtn").disabled = !inRange || state.submitted;

  const hud = document.getElementById("hud");
  hud.classList.toggle("ok", inRange);
}

/* --------- UI RENDER (sliders) ---------- */
function renderBlock(container, list, kind){
  list.forEach((b,idx)=>{
    const row = document.createElement("div");
    row.className="row";
    const id=`${kind}_${idx}`;
    const disabledAttr = b.locked ? "disabled" : "";
    row.innerHTML = `
      <div class="label">${b.label}</div>
      ${b.info?`<div class="hint">${b.info}</div>`:""}
      <div class="hint">Base : ${Math.round(b.base/1000)} Md€</div>
      <div class="sliderWrap">
        <button class="nudge" data-id="${id}" data-d="-1" ${disabledAttr}>−</button>
        <input type="range" id="${id}" min="${CFG.range.min}" max="${CFG.range.max}" step="1" ${b.locked?"value='0' disabled":"value='0'"} />
        <button class="nudge" data-id="${id}" data-d="+1" ${disabledAttr}>+</button>
      </div>
      <div class="valLine">
        <div><span id="${id}_pct">0</span>%</div>
        <div style="text-align:right">
          <div><strong><span id="${id}_new">${fmtM(b.base)}</span> M€</strong></div>
          <div class="delta" id="${id}_delta">0 M€</div>
        </div>
      </div>
    `;
    container.appendChild(row);

    const slider=row.querySelector(`#${id}`);
    const pctEl=row.querySelector(`#${id}_pct`);
    const newEl=row.querySelector(`#${id}_new`);
    const delEl=row.querySelector(`#${id}_delta`);

    const update=()=>{
      const pct=Number(slider.value)||0;
      if(kind==="exp") state.expPct[idx]=pct; else state.revPct[idx]=pct;
      const newVal = Math.round(b.base*(1+(b.locked?0:pct)/100));
      const delta  = newVal - b.base;
      pctEl.textContent = pct;
      newEl.textContent = fmtM(newVal);
      delEl.textContent = `${delta>=0?'+':''}${fmtM(delta)} M€`;
      const isExpense = (kind==="exp");
      const gain = isExpense ? (delta<0) : (delta>0);
      delEl.classList.toggle("gain", gain);
      delEl.classList.toggle("loss", !gain && delta!==0);
      updateHUD();
    };

    slider.addEventListener("input", update); update();

    if (!b.locked){
      let timer=null, stepper=null;
      const startRepeat = (dir)=>{
        const d = Number(dir);
        const tick = ()=>{
          const next = Math.max(CFG.range.min, Math.min(CFG.range.max, Number(slider.value)+d));
          if(Number(slider.value) !== next){ slider.value = String(next); update(); }
        };
        tick();
        let interval = 280;
        stepper = setInterval(()=>{ tick(); }, interval);
        timer = setTimeout(()=>{ clearInterval(stepper); interval=120; stepper=setInterval(()=>{tick();}, interval); }, 600);
      };
      const stopRepeat = ()=>{ if(timer){clearTimeout(timer);timer=null} if(stepper){clearInterval(stepper);stepper=null} };
      row.querySelectorAll(".nudge").forEach(btn=>{
        const dir = btn.dataset.d === "+1" ? +1 : -1;
        btn.addEventListener("pointerdown", (e)=>{ e.preventDefault(); btn.setPointerCapture(e.pointerId); startRepeat(dir); });
        btn.addEventListener("pointerup",   ()=> stopRepeat());
        btn.addEventListener("pointercancel",()=> stopRepeat());
        btn.addEventListener("pointerleave", ()=> stopRepeat());
      });
    }
  });
}

/* --------- BACK (payload) ---------- */
function buildCompactPayload(){
  const r=compute();
  return {
    dataset:"Budget 2026 (base 2024) — normalisation répondant",
    unit:"M€",
    totals2024:{expenses:r.BASE_EXP, revenues:r.BASE_REV, deficit:r.baseDef},
    target:CFG.target, savingsM:r.savingM,
    e: state.expPct.slice(), r: state.revPct.slice(),
    newExpM:r.newExpM, newRevM:r.newRevM, newDeficitM:r.newDeficitM,
    meta:{ua:navigator.userAgent}, ts:new Date().toISOString()
  };
}

/* --------- VIOLINS (Plotly) ---------- */
const FIELD_MAP_EXP = [
  {id:"prot_soc", label:"Protection sociale", field:"E_prot_soc_delta_M€"},
  {id:"sante", label:"Santé", field:"E_sante_delta_M€"},
  {id:"education", label:"Éducation", field:"E_education_delta_M€"},
  {id:"serv_gen", label:"Services publics généraux (hors intérêts dette)", field:"E_serv_gen_delta_M€"},
  {id:"aff_econ", label:"Affaires économiques", field:"E_aff_econ_delta_M€"},
  {id:"defense", label:"Défense", field:"E_defense_delta_M€"},
  {id:"ordre_secu", label:"Ordre & sécurité publics", field:"E_ordre_secu_delta_M€"},
  {id:"logement", label:"Logement & équipements collectifs", field:"E_logement_delta_M€"},
  {id:"environnement", label:"Environnement", field:"E_environnement_delta_M€"},
  {id:"culture", label:"Culture, loisirs et cultes", field:"E_culture_delta_M€"},
];
const FIELD_MAP_REV = [
  {id:"imp_prod", label:"Impôts sur la production et importations", field:"R_imp_prod_delta_M€"},
  {id:"cotis", label:"Cotisations sociales", field:"R_cotis_delta_M€"},
  {id:"ir", label:"Impôt sur le revenu", field:"R_ir_delta_M€"},
  {id:"is", label:"Impôt sur les sociétés", field:"R_is_delta_M€"},
  {id:"autres_rec", label:"Autres recettes", field:"R_autres_rec_delta_M€"},
];

async function fetchDistribution(field){
  try{
    const url = ENDPOINT_URL + "?action=violin&field=" + encodeURIComponent(field);
    const r = await fetch(url, {method:"GET", cache:"no-cache"});
    const j = await r.json();
    if (j && j.ok && Array.isArray(j.values)) return j;
  }catch(e){}
  return { ok:false, values:[], stats:{count:0,min:0,max:0,median:0} };
}

function divFor(container, mapItem){
  const div = document.createElement("div");
  div.id = "v-" + mapItem.id;
  div.style.height = "280px";
  div.style.background = "rgba(255,255,255,.02)";
  div.style.border = "1px dashed #2a3c64";
  div.style.borderRadius = "10px";
  div.style.padding = "6px";
  container.appendChild(div);
  return div.id;
}

function myDeltaForField(field){
  const isExp = field.startsWith("E_");
  if (isExp){
    const idx = CFG.expenses.findIndex(x => ("E_"+x.k+"_delta_M€") === field);
    if (idx<0) return 0;
    const base = CFG.expenses[idx].base;
    const pct  = CFG.expenses[idx].locked ? 0 : (state.expPct[idx]||0);
    const nv   = Math.round(base*(1+pct/100));
    return nv - base;
  }else{
    const idx = CFG.revenues.findIndex(x => ("R_"+x.k+"_delta_M€") === field);
    const base = CFG.revenues[idx].base;
    const pct  = (state.revPct[idx]||0);
    const nv   = Math.round(base*(1+pct/100));
    return nv - base;
  }
}

function drawViolinHybrid(divId, values, stats, myValueME, label){
  const violin = {
    type: "violin", orientation: "h",
    x: values.length? values : [0],
    y: values.map(_ => ""),
    name: label,
    points: "all", jitter: 0.6, scalemode: "count", pointpos: 0,
    marker: { size: 5, opacity: 0.35, color: "rgba(245,203,92,0.7)" }, /* jaune points */
    fillcolor: "rgba(245,203,92,0.25)", line: { color: "rgba(0,0,0,0)" },
    hovertemplate: "%{x:.0f} M€<extra></extra>"
  };

  const medianX = (typeof stats.median === "number") ? stats.median : 0;
  const shapes = [
    { type:"line", x0: medianX, x1: medianX, y0: -0.6, y1: 0.6, line:{ color:"#eab308", width:6 } }, /* médiane jaune */
    { type:"line", x0: myValueME, x1: myValueME, y0: -0.7, y1: 0.7, line:{ color:"#38bdf8", width:6 } }, /* vous bleu */
    { type:"line", x0: 0, x1: 0, y0: -0.8, y1: 0.8, line:{ color:"rgba(148,163,184,0.45)", width:2, dash:"dot" } }
  ];
  const annotations = [
    { x: myValueME, y: 0.75, text: "Vous : " + fmtM(myValueME) + " M€", showarrow:true, arrowhead:6, ax:0, ay:-35,
      font:{color:"#38bdf8",size:12}, bgcolor:"rgba(56,189,248,0.08)", bordercolor:"#38bdf8" },
    { x: medianX, y: -0.75, text: "Médiane : " + fmtM(medianX) + " M€", showarrow:true, arrowhead:6, ax:0, ay:35,
      font:{color:"#eab308",size:12}, bgcolor:"rgba(234,179,8,0.08)", bordercolor:"#eab308" }
  ];

  const min = (typeof stats.min === "number") ? stats.min : Math.min(0,myValueME);
  const max = (typeof stats.max === "number") ? stats.max : Math.max(0,myValueME);
  const margin = Math.max(10, (max - min) * 0.04);

  const layout = {
    paper_bgcolor:"#111827", plot_bgcolor:"#111827", font:{color:"#e2e8f0"},
    margin:{l:10,r:10,t:28,b:42},
    title:{ text: label, x:0, xanchor:"left", y:0.98, font:{size:14} },
    xaxis:{ title:"Variation (en M€)", gridcolor:"#334155", zerolinecolor:"#334155",
            range:[ (min ?? -100)-margin, (max ?? 100)+margin ], tickformat:",.0f" },
    yaxis:{ showticklabels:false },
    shapes, annotations, hovermode:"x unified", showlegend:false
  };
  const isMobile = window.matchMedia("(max-width: 520px)").matches;
  const config = { responsive:true, displayModeBar:false, staticPlot:isMobile };
  Plotly.newPlot(divId, [violin], layout, config);
}

/* --------- RÉSULTATS (parallélisation) ---------- */
async function renderAllViolinsParallel(){
  const expWrap = document.getElementById("violins-expenses");
  const revWrap = document.getElementById("violins-revenues");
  expWrap.innerHTML=""; revWrap.innerHTML="";

  const expJobs = FIELD_MAP_EXP.map(m=>{
    const divId = divFor(expWrap, m);
    const myVal = myDeltaForField(m.field);
    return fetchDistribution(m.field).then(j=>({m,divId,myVal,j}));
  });
  const revJobs = FIELD_MAP_REV.map(m=>{
    const divId = divFor(revWrap, m);
    const myVal = myDeltaForField(m.field);
    return fetchDistribution(m.field).then(j=>({m,divId,myVal,j}));
  });

  const results = await Promise.all([...expJobs, ...revJobs]);
  for (const r of results){
    drawViolinHybrid(r.divId, r.j.values||[], r.j.stats||{}, r.myVal, r.m.label);
  }
}

/* --------- BARRES CENTRÉES SUR 0 ---------- */
function pctInDomain(val, min, max){ if (max===min) return 50; return Math.max(0, Math.min(100, ((val - min) / (max - min)) * 100)); }
function renderBarsZero(expYou, expRef, revYou, revRef){
  const vals = [expYou, expRef, revYou, revRef, 0].filter(v=>typeof v==="number" && isFinite(v));
  if (!vals.length) return;
  const span = Math.max(...vals) - Math.min(...vals);
  const pad = Math.max(5, span * 0.15);
  const dmin = Math.min(...vals) - pad;
  const dmax = Math.max(...vals) + pad;

  const expZero = pctInDomain(0, dmin, dmax);
  const expY = pctInDomain(expYou, dmin, dmax);
  const expR = pctInDomain(expRef, dmin, dmax);
  $("#barExpZero").style.left = expZero + "%";
  $("#barExpYou").style.left  = expY + "%";
  $("#barExpRef").style.left  = expR + "%";
  $("#barExpYouVal").textContent = "Vous : " + (expYou>=0?"+":"") + fmtM(expYou) + " M€";
  $("#barExpRefVal").textContent = "Médiane : " + (expRef>=0?"+":"") + fmtM(expRef) + " M€";

  const revZero = pctInDomain(0, dmin, dmax);
  const revY = pctInDomain(revYou, dmin, dmax);
  const revR = pctInDomain(revRef, dmin, dmax);
  $("#barRevZero").style.left = revZero + "%";
  $("#barRevYou").style.left  = revY + "%";
  $("#barRevRef").style.left  = revR + "%";
  $("#barRevYouVal").textContent = "Vous : " + (revYou>=0?"+":"") + fmtM(revYou) + " M€";
  $("#barRevRefVal").textContent = "Médiane : " + (revRef>=0?"+":"") + fmtM(revRef) + " M€";
}

/* --------- VALIDATE (overlay + gel/déverrouillage) ---------- */
function freezeInputs(freeze){
  document.querySelectorAll("input[type=range], .nudge").forEach(el=>{
    if (el.classList.contains("nudge")) {
      if (freeze) el.setAttribute("disabled",""); else el.removeAttribute("disabled");
    } else {
      const locked = el.hasAttribute("disabled") && el.getAttribute("disabled") !== null && el.getAttribute("disabled") !== "";
      if (!locked) { if (freeze) el.setAttribute("disabled",""); else el.removeAttribute("disabled"); }
    }
  });
}

async function onValidate(){
  const validateBtn = $("#validateBtn");
  const editBtn = $("#editBtn");
  const overlay = $("#overlay");
  state.submitted = true;
  validateBtn.disabled = true;
  editBtn.style.display = "inline-flex";
  freezeInputs(true);
  overlay.classList.add("show");
  $("#validateHint").textContent = "Réponse envoyée — affichage des résultats…";

  // Build payload & client-side hash (anti-doublon)
  const payload = buildCompactPayload();
  const user_key = ensureUserKey();
  const normalized = { e: payload.e.map(Math.round), r: payload.r.map(Math.round) };
  const scenario_hash = await sha256Hex(stableStringify(normalized));

  // POST "simple" (pas de pré-vol CORS)
  try{
    fetch(ENDPOINT_URL, {
      method:"POST",
      mode:"no-cors",
      headers:{"Content-Type":"text/plain;charset=utf-8"},
      body: JSON.stringify({ ...payload, user_key, scenario_hash })
    }).catch(()=>{});
  }catch(_){}

  // Affiche résultats
  $("#results").style.display="block";

  // Récupère référence (moyennes) + count
  try{
    const statsRes = await fetch(ENDPOINT_URL + "?stats=1", {method:"GET", cache:"no-cache"});
    const stats = await statsRes.json();
    if(stats && stats.ok){
      state.avgExpPct = stats.avgExpPct || [];
      state.avgRevPct = stats.avgRevPct || [];
      state.count = stats.count || 0;
      $("#ansCountLine").textContent = `Réponses enregistrées : ${state.count.toLocaleString("fr-FR")}`;
    } else {
      $("#ansCountLine").textContent = `Réponses enregistrées : —`;
    }
  }catch(_){
    $("#ansCountLine").textContent = `Réponses enregistrées : —`;
  }

  // Résumé texte
  const you = compute();
  const ref  = computeRefFromAverages();
  $("#sumCutsYou").textContent = fmtM(you.cutsExp);
  $("#sumIncYou").textContent  = fmtM(you.incRev);
  $("#sumCutsAvg").textContent = fmtM(ref.cutsExp || 0);
  $("#sumIncAvg").textContent  = fmtM(ref.incRev || 0);

  // Barres centrées sur 0 (Δ totaux signés)
  renderBarsZero(you.deltaExpTotal, ref.deltaExpTotal || 0, you.deltaRevTotal, ref.deltaRevTotal || 0);

  // Violons
  await renderAllViolinsParallel();

  $("#validateHint").textContent="Réponse enregistrée ✔ — résultats ci-dessous.";
  overlay.classList.remove("show");
}

function onEdit(){
  state.submitted = false;
  $("#validateBtn").disabled = false;
  $("#editBtn").style.display = "none";
  $("#validateHint").textContent="Modifiez vos curseurs puis revalidez.";
  freezeInputs(false);
}

/* --------- INIT ---------- */
function init(){
  renderBlock(document.getElementById("expContainer"), CFG.expenses, "exp");
  renderBlock(document.getElementById("revContainer"), CFG.revenues, "rev");
  updateHUD();
  $("#validateBtn").addEventListener("click", onValidate);
  $("#editBtn").addEventListener("click", onEdit);
}
document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
