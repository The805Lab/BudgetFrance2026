<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<!-- Empêche le double-tap zoom sur iOS pour des boutons +/− plus fluides -->
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>BudgetLab — Trouver 40 Md€ pour le budget 2026</title>
<style>
  :root{
    /* Palette bleue unifiée (pas de vert de fond) */
    --bg:#0a1022; 
    --panel:#0f1a33; 
    --panel2:#0b1530;
    --ring:#21315a;
    --text:#e8f0ff; 
    --muted:#a7b5cf;
    --ok:#16a34a; 
    --bad:#ef4444;

    /* Sections distinctes en bleus */
    --expBg:#0e254f;   /* Dépenses */
    --revBg:#0b1f45;   /* Recettes */

    --chip:#0c1636;
    --brand:#2563eb;
  }
  *{box-sizing:border-box}
  body{
    margin:0;background:var(--bg);color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    touch-action: pan-y; /* laisse défiler verticalement, évite les conflits */
  }
  .wrap{max-width:980px;margin:0 auto;padding:16px}

  /* En-tête minimal, lisible */
  h1{margin:0 0 6px;font-size:1.22rem;line-height:1.25}
  .subtitle{color:var(--muted);font-size:.92rem;margin-bottom:10px}

  /* Barre de progression compacte sous le titre */
  .bar{height:10px;background:#1a2746;border-radius:999px;overflow:hidden;margin:8px 0 14px}
  .bar>span{display:block;height:100%;background:linear-gradient(90deg,#dc2626,#eab308,#16a34a);width:0%}

  .card{background:var(--panel);border:1px solid var(--ring);border-radius:14px;padding:14px;margin:12px 0}

  /* Sections très contrastées (bleus) */
  .section{border-radius:16px;border:1px solid var(--ring);margin:14px 0;overflow:hidden; overscroll-behavior:contain}
  .section.exp{background:var(--expBg)}
  .section.rev{background:var(--revBg)}
  .head{padding:12px 14px;background:rgba(255,255,255,.05);display:flex;gap:12px;align-items:center;font-weight:700}
  .badge{padding:2px 8px;border-radius:999px;border:1px solid var(--ring);background:#0b152f;color:#dce7ff;font-size:.8rem}
  .row{padding:12px 14px;border-top:1px dashed #274067}

  .label{font-weight:700}
  .hint{color:var(--muted);font-size:.9rem;margin-top:2px}

  /* Sliders : amplitude -15/+15, bouton +/− avec auto-repeat, meilleure prise en main */
  .sliderWrap{display:grid;grid-template-columns:42px 1fr 42px;gap:8px;align-items:center}
  .nudge{
    width:42px;height:42px;border-radius:12px;border:1px solid var(--ring);
    background:#0b1633;color:#cfe1ff;cursor:pointer;font-weight:700;font-size:1rem;
    touch-action: manipulation; /* évite double-tap zoom */
  }
  .nudge:active{transform:scale(.98)}
  input[type=range]{width:100%;margin:8px 0;height:36px; /* hauteur plus grande */
    touch-action: pan-y;  /* autorise le drag et empêche conflits */
  }
  input[type=range]::-webkit-slider-runnable-track{height:10px;background:#2a3c69;border-radius:999px}
  input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;margin-top:-7px;width:26px;height:26px;border-radius:50%;background:var(--brand);border:2px solid #a5b4fc}
  input[type=range]::-moz-range-track{height:10px;background:#2a3c69;border-radius:999px}
  input[type=range]::-moz-range-thumb{width:24px;height:24px;border:none;border-radius:50%;background:var(--brand)}
  .valLine{display:flex;justify-content:space-between;gap:8px;margin-top:6px;align-items:center}
  .delta{font-variant-numeric:tabular-nums}
  .delta.gain{color:var(--ok)}
  .delta.loss{color:var(--bad)}

  /* Bulle fixe qui suit l’écran : économie & écart (mobile & desktop) */
  .floatBubble{
    position:fixed; right:14px; bottom:14px; z-index:50;
    background:#0b172f;border:1px solid var(--ring); border-radius:12px; padding:10px 12px;
    box-shadow:0 6px 24px rgba(0,0,0,.35); font-size:.95rem
  }
  .floatBubble strong{color:#fff}

  /* Bouton Valider plus visible */
  .btn{
    display:inline-flex;gap:.6rem;align-items:center;background:var(--brand);color:#fff;
    border:0;border-radius:12px;padding:14px 16px;cursor:pointer;font-weight:700;font-size:1.02rem
  }
  .btn:disabled{background:#334155;color:#94a3b8;cursor:not-allowed}
  .btn.wide{width:100%}
  @media (min-width:760px){.btn.wide{width:auto;padding:12px 18px}}

  /* Résultats : figure + détail par postes */
  .results{display:none}
  .figure{
    background:var(--panel2);border:1px solid var(--ring);border-radius:12px;padding:12px;margin-bottom:12px
  }
  .figureTitle{font-weight:700;margin-bottom:8px}
  .bars{display:grid;gap:10px}
  .barH{height:14px;background:#1f2c4e;border:1px solid #2a3c69;border-radius:999px;overflow:hidden}
  .barH>span{display:block;height:100%}
  .barExp{background:#0ea5e9} /* bleu clair pour dépenses */
  .barRev{background:#60a5fa} /* bleu différent pour recettes */

  .cmpCard{padding:10px;border:1px dashed #2a3c64;border-radius:10px;margin:8px 0;background:rgba(255,255,255,.03)}
  .cmpTitle{font-weight:700;margin-bottom:6px}
  .cmpLine{display:flex;justify-content:space-between;color:var(--muted);font-size:.95rem}
  .cmpLine span:last-child{font-variant-numeric:tabular-nums}
  .legend{color:var(--muted);font-size:.9rem;margin:6px 0 8px}

  .footer{color:var(--muted);font-size:.85rem;margin-top:16px}
  .toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:#0b172f;border:1px solid var(--ring);color:#e6f0ff;border-radius:10px;padding:10px 12px;box-shadow:0 6px 20px rgba(0,0,0,.35);z-index:60;display:none}
</style>
</head>
<body>
<div class="wrap">
  <!-- Titre ajusté : objectif 2026, mention base 2024 discrète -->
  <h1>À vous de trouver <strong>40 Md€</strong> pour le budget 2026 (France)</h1>
  <div class="subtitle">Référence : <em>base 2024</em></div>
  <div class="bar"><span id="bar"></span></div>

  <!-- Dépenses -->
  <div class="section exp">
    <div class="head">Dépenses <span class="badge">curseurs −15 % à +15 %</span></div>
    <div id="expContainer"></div>
  </div>

  <!-- Recettes -->
  <div class="section rev">
    <div class="head">Recettes <span class="badge">curseurs −15 % à +15 %</span></div>
    <div id="revContainer"></div>
  </div>

  <!-- Actions -->
  <div class="card">
    <button id="validateBtn" class="btn wide" disabled>Valider mon budget</button>
    <div class="hint" id="validateHint" style="margin-top:6px;">Le bouton s’active quand l’économie est entre 40 000 et 45 000 M€.</div>
  </div>

  <!-- Résultats -->
  <div id="results" class="card results">
    <h2 style="margin:0 0 10px;font-size:1.06rem">Mes résultats — comparaison normalisée</h2>
    <div class="legend" id="normNote">Comparaison : <strong>Vous</strong> vs <strong>Moyenne</strong> (normalisée à votre économie). <span id="ansCount"></span></div>

    <!-- Figure synthèse -->
    <div class="figure">
      <div class="figureTitle">Synthèse de votre ajustement</div>
      <div class="bars">
        <div>
          <div class="cmpLine" style="margin-bottom:4px"><span>Économies sur dépenses</span><span id="figExpVal">0 M€ (0%)</span></div>
          <div class="barH"><span id="figExpBar" class="barExp" style="width:0%"></span></div>
        </div>
        <div>
          <div class="cmpLine" style="margin-bottom:4px"><span>Recettes supplémentaires</span><span id="figRevVal">0 M€ (0%)</span></div>
          <div class="barH"><span id="figRevBar" class="barRev" style="width:0%"></span></div>
        </div>
      </div>
    </div>

    <!-- Détail par postes -->
    <div class="section exp" style="margin-top:10px">
      <div class="head">Dépenses — Δ par poste (M€ / %)</div>
      <div id="cmpExp"></div>
    </div>
    <div class="section rev" style="margin-top:10px">
      <div class="head">Recettes — Δ par poste (M€ / %)</div>
      <div id="cmpRev"></div>
    </div>
  </div>

  <div class="footer">
    Sources : Insee (APU), Ministère de l’Économie, Commission européenne. Chiffres 2024 arrondis. Certains postes sont difficiles à ajuster à court terme (ex. intérêts de la dette).
  </div>
</div>

<!-- Bulle flottante permanente (économie & écart) -->
<div class="floatBubble">
  <div>Économie : <strong id="hudSaving">0 M€</strong></div>
  <div style="color:var(--muted)">Écart : <strong id="hudGap">≥40 000 M€</strong></div>
</div>

<div id="toast" class="toast"></div>

<script>
/* --------- CONFIG ---------- */
const ENDPOINT_URL = "https://script.google.com/macros/s/AKfycbxHnolZm-C31zBPKrg7sWLNLGD9PELL5en5OBDjGuDjPvgZydE_cY_WoNv7Q_-ms8Ur/exec";

const CFG = {
  target:{min:40000, max:45000},
  // bases 2024 (M€)
  expenses: [
    {k:"prot_soc",label:"Protection sociale",base:701400,info:"(Retraites, allocations, chômage, minima sociaux.)",locked:false},
    {k:"sante",label:"Santé",base:250500,info:"",locked:false},
    {k:"education",label:"Éducation",base:167000,info:"",locked:false},
    {k:"serv_gen",label:"Services publics généraux (hors intérêts de la dette)",base:120000,info:"",locked:false},
    {k:"interets_dette",label:"Charges d’intérêts de la dette (non modifiable)",base:58700,info:"(Service de la dette — verrouillé.)",locked:true},
    {k:"aff_econ",label:"Affaires économiques",base:167000,info:"",locked:false},
    {k:"defense",label:"Défense",base:75200,info:"",locked:false},
    {k:"ordre_secu",label:"Ordre & sécurité publics",base:50100,info:"",locked:false},
    {k:"logement",label:"Logement & équipements collectifs",base:30100,info:"",locked:false},
    {k:"environnement",label:"Protection de l’environnement",base:30100,info:"",locked:false},
    {k:"culture",label:"Culture, loisirs et cultes",base:20000,info:"",locked:false},
  ],
  revenues: [
    {k:"imp_prod",label:"Impôts sur la production et importations",base:570000},
    {k:"cotis",label:"Cotisations sociales",base:480000},
    {k:"ir",label:"Impôt sur le revenu",base:120000},
    {k:"is",label:"Impôt sur les sociétés",base:80000},
    {k:"autres_rec",label:"Autres recettes",base:252000},
  ],
  range:{min:-15,max:15}
};

/* --------- STATE ---------- */
const state = {
  expPct: CFG.expenses.map(()=>0),
  revPct: CFG.revenues.map(()=>0),
  stats: null // {count, avgExpPct[], avgRevPct[]}
};

/* --------- UTILS ---------- */
const fmtM = n => (Math.round(n)).toLocaleString("fr-FR");
const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));
function toast(msg){
  const el=document.getElementById("toast");
  el.textContent=msg; el.style.display="block";
  setTimeout(()=>{el.style.display="none"}, 2400);
}

/* --------- CALCULS ---------- */
function compute(){
  const newExp = CFG.expenses.map((b,i)=> Math.round(b.base*(1+(b.locked?0:state.expPct[i])/100)) );
  const newRev = CFG.revenues.map((b,i)=> Math.round(b.base*(1+state.revPct[i]/100)) );
  const BASE_EXP = CFG.expenses.reduce((s,b)=>s+b.base,0);
  const BASE_REV = CFG.revenues.reduce((s,b)=>s+b.base,0);
  const baseDef = BASE_EXP - BASE_REV;

  const newExpM = newExp.reduce((s,x)=>s+x,0);
  const newRevM = newRev.reduce((s,x)=>s+x,0);
  const newDef = newExpM - newRevM;
  const savingM = baseDef - newDef; // économies (+) si déficit baisse

  // figure: économies dépense (seulement si delta<0) + hausses de recettes (delta>0)
  const cutsExp = CFG.expenses.reduce((sum,b,i)=>{
    const nv = newExp[i]; const d = nv - b.base;
    return sum + (d<0 ? -d : 0);
  },0);
  const incRev = CFG.revenues.reduce((sum,b,i)=>{
    const nv = newRev[i]; const d = nv - b.base;
    return sum + (d>0 ? d : 0);
  },0);

  return {BASE_EXP, BASE_REV, baseDef, newExp, newRev, newExpM, newRevM, newDeficitM:newDef, savingM, cutsExp, incRev};
}

function updateKPIs_andHUD(){
  const r = compute();
  const saving = r.savingM;
  const pct = clamp((saving/CFG.target.max)*100,0,100);
  const inRange = (saving>=CFG.target.min && saving<=CFG.target.max);

  document.getElementById("hudSaving").textContent = `${fmtM(saving)} M€`;

  let gapText;
  if (!inRange){
    if (saving < CFG.target.min) gapText = `≥${fmtM(CFG.target.min - saving)} M€ à trouver`;
    else gapText = `≤${fmtM(saving - CFG.target.max)} M€ à retirer`;
  } else gapText = "OK (dans la cible)";
  document.getElementById("hudGap").textContent = gapText;

  document.getElementById("bar").style.width = pct+"%";
  document.getElementById("validateBtn").disabled = !inRange;

  // figure live (utile même avant validation)
  const total = Math.max(1, r.cutsExp + r.incRev);
  const expPct = r.cutsExp / total * 100;
  const revPct = r.incRev / total * 100;
  document.getElementById("figExpBar").style.width = expPct.toFixed(1) + "%";
  document.getElementById("figRevBar").style.width = revPct.toFixed(1) + "%";
  document.getElementById("figExpVal").textContent = `${fmtM(r.cutsExp)} M€ (${expPct.toFixed(0)}%)`;
  document.getElementById("figRevVal").textContent = `${fmtM(r.incRev)} M€ (${revPct.toFixed(0)}%)`;
}

/* --------- UI RENDER ---------- */
function renderBlock(container, list, kind){
  list.forEach((b,idx)=>{
    const row = document.createElement("div");
    row.className="row";
    const id=`${kind}_${idx}`;

    row.innerHTML = `
      <div class="label">${b.label}</div>
      ${b.info?`<div class="hint">${b.info}</div>`:""}
      <div class="hint">Base : ${Math.round(b.base/1000)} Md€</div>
      <div class="sliderWrap">
        <button class="nudge" data-id="${id}" data-d="-1">−</button>
        <input type="range" id="${id}" min="${CFG.range.min}" max="${CFG.range.max}" step="1" ${b.locked?"value='0' disabled":"value='0'"} />
        <button class="nudge" data-id="${id}" data-d="+1">+</button>
      </div>
      <div class="valLine">
        <div><span id="${id}_pct">0</span>%</div>
        <div style="text-align:right">
          <div><strong><span id="${id}_new">${fmtM(b.base)}</span> M€</strong></div>
          <div class="delta" id="${id}_delta">0 M€</div>
        </div>
      </div>
    `;
    container.appendChild(row);

    const slider=row.querySelector(`#${id}`);
    const pctEl=row.querySelector(`#${id}_pct`);
    const newEl=row.querySelector(`#${id}_new`);
    const delEl=row.querySelector(`#${id}_delta`);

    const update=()=>{
      const pct=Number(slider.value)||0;
      if(kind==="exp") state.expPct[idx]=pct; else state.revPct[idx]=pct;
      const newVal = Math.round(b.base*(1+(b.locked?0:pct)/100));
      const delta  = newVal - b.base;
      pctEl.textContent = pct;
      newEl.textContent = fmtM(newVal);
      delEl.textContent = `${delta>=0?'+':''}${fmtM(delta)} M€`;
      const isExpense = (kind==="exp");
      const gain = isExpense ? (delta<0) : (delta>0);
      delEl.classList.toggle("gain", gain);
      delEl.classList.toggle("loss", !gain && delta!==0);
      updateKPIs_andHUD();
    };

    slider.addEventListener("input", update);
    update();

    // Boutons +/- : auto-repeat au maintien (évite double-tap zoom)
    let timer=null, stepper=null;
    const startRepeat = (dir)=>{
      const d = Number(dir);
      const tick = ()=>{
        const next = Math.max(CFG.range.min, Math.min(CFG.range.max, Number(slider.value)+d));
        if(Number(slider.value) !== next){
          slider.value = String(next);
          update();
        }
      };
      tick();
      // accélération douce
      let interval = 280;
      stepper = setInterval(()=>{ tick(); }, interval);
      timer = setTimeout(()=>{
        clearInterval(stepper);
        interval = 120;
        stepper = setInterval(()=>{ tick(); }, interval);
      }, 600);
    };
    const stopRepeat = ()=>{
      if(timer){ clearTimeout(timer); timer=null; }
      if(stepper){ clearInterval(stepper); stepper=null; }
    };
    row.querySelectorAll(".nudge").forEach(btn=>{
      const dir = btn.dataset.d === "+1" ? +1 : -1;
      // pointer events = fiable mobile/desktop, évite double-tap
      btn.addEventListener("pointerdown", (e)=>{ e.preventDefault(); btn.setPointerCapture(e.pointerId); startRepeat(dir); });
      btn.addEventListener("pointerup",   ()=> stopRepeat());
      btn.addEventListener("pointercancel",()=> stopRepeat());
      btn.addEventListener("pointerleave", ()=> stopRepeat());
    });
  });
}

/* --------- BACK (POST/GET) ---------- */
function buildCompactPayload(){
  const r=compute();
  return {
    dataset:"Budget 2026 (base 2024) — normalisation répondant",
    unit:"M€",
    totals2024:{expenses:r.BASE_EXP, revenues:r.BASE_REV, deficit:r.baseDef},
    target:CFG.target, savingsM:r.savingM,
    e: state.expPct.slice(), r: state.revPct.slice(),
    newExpM:r.newExpM, newRevM:r.newRevM, newDeficitM:r.newDeficitM,
    meta:{ua:navigator.userAgent}, ts:new Date().toISOString()
  };
}
function sendToSheet(payload){
  try{
    fetch(ENDPOINT_URL,{
      method:"POST", mode:"no-cors",
      headers:{"Content-Type":"text/plain;charset=utf-8"},
      body: JSON.stringify(payload)
    });
  }catch(e){}
}
async function fetchStats(){
  try{
    const url = ENDPOINT_URL + "?stats=1";
    const r = await fetch(url, {method:"GET", cache:"no-cache"});
    if(!r.ok) return null;
    const data = await r.json();
    if(!data || !data.ok) return null;
    return data; // {count, avgExpPct[], avgRevPct[]}
  }catch(e){ return null }
}

/* --------- NORMALISATION & COMPARAISON ---------- */
function savingsFromPct(avgExpPct, avgRevPct){
  const newExp = CFG.expenses.map((b,i)=> Math.round(b.base*(1+(b.locked?0:avgExpPct[i])/100)) );
  const newRev = CFG.revenues.map((b,i)=> Math.round(b.base*(1+avgRevPct[i]/100)) );
  const BASE_EXP = CFG.expenses.reduce((s,b)=>s+b.base,0);
  const BASE_REV = CFG.revenues.reduce((s,b)=>s+b.base,0);
  const baseDef  = BASE_EXP - BASE_REV;
  const newDef   = newExp.reduce((s,x)=>s+x,0) - newRev.reduce((s,x)=>s+x,0);
  return (baseDef - newDef);
}

function renderComparison(avgExpPct, avgRevPct, respondentSavingsM){
  const avgSavingsM = savingsFromPct(avgExpPct, avgRevPct) || 1;
  const k = respondentSavingsM / avgSavingsM;

  const expWrap = document.getElementById("cmpExp");
  const revWrap = document.getElementById("cmpRev");
  expWrap.innerHTML=""; revWrap.innerHTML="";

  const makeCard = (parent, label, base, yourPct, meanPct, isExpense, locked=false)=>{
    const yourNew = Math.round(base*(1+(locked?0:yourPct)/100));
    const meanNew = Math.round(base*(1+(locked?0:(meanPct*k))/100)); // moyenne *normalisée*
    const yourDelta = yourNew - base;
    const meanDelta = meanNew - base;

    const gainYou  = isExpense ? (yourDelta<0) : (yourDelta>0);
    const gainMean = isExpense ? (meanDelta<0) : (meanDelta>0);

    const div=document.createElement("div");
    div.className="cmpCard";
    div.innerHTML=`
      <div class="cmpTitle">${label}${locked?` <span class="badge">verrouillé</span>`:""}</div>
      <div class="cmpLine">
        <span>Vous</span>
        <span style="color:${gainYou?'#16a34a':(yourDelta!==0?'#ef4444':'#a9b8d2')}">
          ${yourPct>=0?'+':''}${yourPct}% · ${yourDelta>=0?'+':''}${fmtM(yourDelta)} M€
        </span>
      </div>
      <div class="cmpLine">
        <span>Moyenne</span>
        <span style="color:${gainMean?'#16a34a':(meanDelta!==0?'#ef4444':'#a9b8d2')}">
          ${(meanPct*k)>=0?'+':''}${(meanPct*k).toFixed(1)}% · ${meanDelta>=0?'+':''}${fmtM(meanDelta)} M€
        </span>
      </div>`;
    parent.appendChild(div);
  };

  CFG.expenses.forEach((b,i)=> makeCard(expWrap, b.label, b.base, state.expPct[i], (avgExpPct[i]||0), true, b.locked));
  CFG.revenues.forEach((b,i)=> makeCard(revWrap, b.label, b.base, state.revPct[i], (avgRevPct[i]||0), false));
}

/* --------- CLIC VALIDER ---------- */
async function onValidate(){
  const payload = buildCompactPayload();
  sendToSheet(payload);

  // Résultats + stats
  document.getElementById("results").style.display="block";
  const stats = await fetchStats(); // {ok,count,avgExpPct,avgRevPct}
  const mySavings = compute().savingM;

  if(stats){
    document.getElementById("ansCount").textContent = `— Réponses dans la base : ${stats.count}`;
    renderComparison(stats.avgExpPct||[], stats.avgRevPct||[], mySavings);
    document.getElementById("normNote").style.display = "block";
    document.getElementById("validateHint").textContent="Réponse envoyée ✔ — résultats affichés ci-dessous.";
  }else{
    document.getElementById("ansCount").textContent = "";
    document.getElementById("normNote").textContent =
      "Comparaison indisponible (statistiques non accessibles). Votre réponse a été enregistrée.";
  }

  // Scroll vers résultats
  document.getElementById("results").scrollIntoView({behavior:"smooth", block:"start"});
}

/* --------- INIT ---------- */
function init(){
  renderBlock(document.getElementById("expContainer"), CFG.expenses, "exp");
  renderBlock(document.getElementById("revContainer"), CFG.revenues, "rev");
  updateKPIs_andHUD();

  document.getElementById("validateBtn").addEventListener("click", onValidate);
}
document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
