<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>BudgetLab ‚Äì Violin lisible</title>
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
  <style>
    body{font-family:Inter,system-ui,Arial,sans-serif;background:#0f172a;color:#e2e8f0;margin:0;padding:16px}
    .card{background:#111827;border:1px solid #1f2937;border-radius:14px;padding:16px;margin:12px 0}
    h1{font-size:20px;margin:0 0 8px}
    .caption{color:#a1a1aa;font-size:12px;margin-top:8px}
    #violin-prot-soc {width:100%; height:260px;}
    .legendRow{display:flex;gap:12px;align-items:center;margin-top:8px;font-size:13px;color:#cbd5e1}
    .pill{width:14px;height:8px;border-radius:4px;background:#f3d9a7}
    .pillMean{width:16px;height:4px;background:#eab308}
    .pillMine{width:16px;height:4px;background:#38bdf8}
  </style>
</head>
<body>

  <div class="card">
    <h1>Protection sociale ‚Äì dispersion des r√©ponses (variation en M‚Ç¨)</h1>
    <div id="violin-prot-soc"></div>
    <div class="legendRow">
      <span class="pill"></span> Distribution (base)
      <span class="pillMean"></span> M√©diane (base)
      <span class="pillMine"></span> Votre valeur
    </div>
    <div id="ps-stats" class="caption"></div>
  </div>

<script>
(async function(){
  // üëâ 1) Ton Apps Script (lecture) :
  const ENDPOINT_URL = "https://script.google.com/macros/s/AKfycbxHnolZm-C31zBPKrg7sWLNLGD9PELL5en5OBDjGuDjPvgZydE_cY_WoNv7Q_-ms8Ur/exec";

  // üëâ 2) TA valeur pour cette cat√©gorie (Œî en M‚Ç¨). Pour un vrai branchement,
  // lis la valeur sauvegard√©e par le simulateur (ex. localStorage) :
  // const saved = localStorage.getItem("budgetlab:last");
  // const myValueME = saved ? Number(JSON.parse(saved)["E_prot_soc_delta_M‚Ç¨"] ?? 0) : -42084;
  const myValueME = -42084; // exemple

  // 3) R√©cup√®re la distribution depuis ta base
  let data = { ok:false };
  try {
    const url = ENDPOINT_URL + "?action=violin&field=" + encodeURIComponent("E_prot_soc_delta_M‚Ç¨");
    const res = await fetch(url, { method:"GET" });
    data = await res.json();
  } catch(e) {
    console.warn("Fetch error (utilisation de donn√©es de secours pour tester).", e);
  }

  // 4) Donn√©es de secours si la base est vide
  if (!data.ok || !Array.isArray(data.values) || data.values.length === 0) {
    data = {
      ok: true,
      field: "E_prot_soc_delta_M‚Ç¨",
      values: [-70000,-52000,-49000,-43000,-41000,-38000,-30000,-15000,-5000, 2000, 8000, 12000],
      stats: { count:12, min:-70000, max:12000, mean:-27500, median:-35500 }
    };
  }

  const values = data.values;
  const stats  = data.stats || {min:0,max:0,median:0,count:values.length};
  const medianX = (typeof stats.median === "number") ? stats.median : 0;

  // 5) Courbe de densit√© (violin) ‚Äì horizontale
  const violin = {
    type: "violin",
    orientation: "h",
    x: values,         // Œî en M‚Ç¨
    y: values.map(_ => ""), // une seule bande
    name: "Base",
    points: false,     // pas de points individuels
    bandwidth: 0.5,    // lissage raisonnable
    fillcolor: "rgba(245, 203, 92, 0.35)",   // beige
    line: { color: "rgba(0,0,0,0)" },        // pas de contour
    hovertemplate: "%{x:.0f} M‚Ç¨<extra></extra>"
  };

  // 6) Barres visibles : m√©diane (jaune) + votre valeur (bleu)
  //    On utilise des "shapes" pour des barres √©paisses + labels explicites.
  const shapes = [
    // m√©diane
    {
      type: "line",
      x0: medianX, x1: medianX,
      y0: -0.6, y1: 0.6,
      line: { color: "#eab308", width: 6 }   // jaune √©pais
    },
    // votre valeur
    {
      type: "line",
      x0: myValueME, x1: myValueME,
      y0: -0.7, y1: 0.7,
      line: { color: "#38bdf8", width: 6 }   // bleu √©pais
    },
    // ligne z√©ro (r√©f√©rence visuelle)
    {
      type: "line",
      x0: 0, x1: 0,
      y0: -0.8, y1: 0.8,
      line: { color: "rgba(148,163,184,0.45)", width: 2, dash: "dot" }
    }
  ];

  // 7) Annotations lisibles pour grand public
  const annotations = [
    {
      x: myValueME, y: 0.75,
      text: "Vous : " + fmt(myValueME) + " M‚Ç¨",
      showarrow: true, arrowhead: 6, ax: 0, ay: -35,
      font: { color: "#38bdf8", size: 12 },
      bgcolor: "rgba(56,189,248,0.08)", bordercolor:"#38bdf8"
    },
    {
      x: medianX, y: -0.75,
      text: "M√©diane : " + fmt(medianX) + " M‚Ç¨",
      showarrow: true, arrowhead: 6, ax: 0, ay: 35,
      font: { color: "#eab308", size: 12 },
      bgcolor: "rgba(234,179,8,0.08)", bordercolor:"#eab308"
    }
  ];

  // 8) Mise en page
  const margin = Math.max(10, (stats.max - stats.min) * 0.04);
  const layout = {
    paper_bgcolor: "#111827",
    plot_bgcolor: "#111827",
    font: { color: "#e2e8f0" },
    margin: { l: 10, r: 10, t: 10, b: 42 },
    xaxis: {
      title: "Variation (en M‚Ç¨) ‚Äî n√©gatif = √©conomies",
      gridcolor: "#334155",
      zerolinecolor: "#334155",
      range: [ (stats.min ?? -100) - margin, (stats.max ?? 100) + margin ],
      tickformat: ",.0f"
    },
    yaxis: { showticklabels: false },
    shapes,
    annotations,
    hovermode: "x unified",          // bulle unique lisible au survol
    showlegend: false
  };

  // 9) All√©ger l‚Äôinteraction sur mobile
  const isMobile = window.matchMedia("(max-width: 520px)").matches;
  const config = {
    responsive: true,
    displayModeBar: false,
    staticPlot: isMobile,            // sur mobile : pas de zoom/pan (plus l√©ger)
  };

  Plotly.newPlot("violin-prot-soc", [violin], layout, config);

  // 10) Petit r√©sum√© chiffr√© en bas
  const el = document.getElementById("ps-stats");
  el.textContent = `R√©ponses : n=${stats.count ?? values.length} ‚Ä¢ min=${fmt(stats.min)} M‚Ç¨ ‚Ä¢ m√©diane=${fmt(medianX)} M‚Ç¨ ‚Ä¢ max=${fmt(stats.max)} M‚Ç¨`;

  function fmt(v){ return (typeof v === "number") ? Math.round(v).toLocaleString("fr-FR") : "‚Äî"; }
})();
</script>

</body>
</html>
